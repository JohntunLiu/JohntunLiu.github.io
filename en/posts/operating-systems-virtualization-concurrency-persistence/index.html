<!doctype html><html lang=en dir=ltr><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Operating Systems: Virtualization, Concurrency & Persistence ‚Äì ËùâËØ≠</title><script defer src=/js/fuse.min.32195737929df2c8096e855a5789cbb3f1331224d9169e8705493e7008f47df8.js></script><script src=/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js></script><script defer src=/js/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js></script><script defer src=/js/helper/getParents.min.ccd45f158c1b17849307ba913a72beac239c410f2b6e648496a79842da84e55b.js></script><script defer src=/js/helper/fadeinout.min.1d13d3e810c3940e80cbba6216a1c76fbf42b5431fc83537ea6997863802362b.js></script><script defer src=/js/helper/closest.min.js></script><script>"use strict";window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),String.prototype.includes||(String.prototype.includes=function(b,a){'use strict';if(b instanceof RegExp)throw TypeError('first argument must not be a RegExp');return a===void 0&&(a=0),this.indexOf(b,a)!==-1}),Document.prototype.append=Element.prototype.append=function(){this.appendChild(_mutation(arguments))};function _mutation(a){if(!a.length)throw new Error('DOM Exception 8');if(a.length===1)return typeof a[0]=='string'?document.createTextNode(a[0]):a[0];for(var c=document.createDocumentFragment(),e=a.length,d=-1,b;++d<e;)b=a[d],c.appendChild(typeof b=='string'?document.createTextNode(b):b);return c}String.prototype.startsWith||(String.prototype.startsWith=function(b,a){return a=a||0,this.indexOf(b,a)===a}),document.addEventListener('DOMContentLoaded',function(){var z=document.querySelector('.navbar__burger'),Y,E,D,X,U,f,d,R,s,ai,P,N,o,g,A,l,b,t,r,L,K,e,C,h,G,B,aa,y,ar,aq,ap,ao,an,F,am,ae,al,aj,i,j,c,ag,S,af,v,V,W,ad,x,q,T,p,au,at,a,av,M,n,I,H,J,u,m,w;z?z.addEventListener('click',function(c){var a=document.querySelector('.navbarm__collapse'),b;a&&(b=a.getAttribute('data-open'),b==='true'?(a.setAttribute('data-open','false'),a.style.maxHeight=0,z.classList.remove('is-active')):(a.setAttribute('data-open','true'),a.style.maxHeight=a.scrollHeight+"px",z.classList.add('is-active')))}):null,Y=document.querySelectorAll('.single__contents > table');for(let a=0;a<Y.length;a++)E=Y[a],D=document.createElement('div'),D.className='table-wrapper',E.parentElement.replaceChild(D,E),D.appendChild(E);X=document.querySelectorAll('.footnote-ref'),U=document.querySelectorAll('.footnote-backref'),X?X.forEach(function(a,c){a.onmouseenter=function(){b.classList.contains('scrolling')&&b.classList.remove('scrolling')},a.onmouseleave=function(){b.classList.contains('scrolling')||setTimeout(function(){b.classList.add('scrolling')},100)},a.onclick=function(){b.classList.contains('scrolling')||(b.classList.remove('navbar--show'),b.classList.remove('navbar--hide'),b.classList.add('navbar--hide'))}}):null,U?U.forEach(function(a,c){a.onmouseenter=function(){b.classList.contains('scrolling')&&b.classList.remove('scrolling')},a.onmouseleave=function(){b.classList.contains('scrolling')||setTimeout(function(){b.classList.add('scrolling')},100)},a.onclick=function(){b.classList.contains('scrolling')||(b.classList.remove('navbar--show'),b.classList.remove('navbar--hide'),b.classList.add('navbar--hide'))}}):null,f=document.querySelector('.summary__container'),d=document.querySelector('.search-result'),R=document.querySelector('.search-result__close'),R?R.addEventListener('click',function(a){d.setAttribute('data-display','none'),f.setAttribute('data-display','block')}):null,document.querySelectorAll('.tab')?document.querySelectorAll('.tab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.tab__link'),c=a.querySelectorAll('.tab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,document.querySelectorAll('.codetab')?document.querySelectorAll('.codetab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.codetab__link'),c=a.querySelectorAll('.codetab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,s=document.getElementById("gtt"),s.style.display="none",s.addEventListener('click',function(){window.document.documentMode?document.documentElement.scrollTop=0:ah(250)});function ah(a){var b=-window.scrollY/(a/15),c=setInterval(function(){window.scrollY!=0?window.scrollBy(0,b):clearInterval(c)},15)}ai=function(){document.body.scrollTop>250||document.documentElement.scrollTop>250?s.style.display="block":s.style.display="none"},P=document.querySelectorAll('.expand__button');for(let a=0;a<P.length;a++)P[a].addEventListener("click",function(){var a=this.nextElementSibling;a.style.maxHeight?(a.style.maxHeight=null,this.querySelector('svg').classList.add('expand-icon__right'),this.querySelector('svg').classList.remove('expand-icon__down')):(a.style.maxHeight=a.scrollHeight+"px",this.querySelector('svg').classList.remove('expand-icon__right'),this.querySelector('svg').classList.add('expand-icon__down'))});N=window.pageYOffset||document.documentElement.scrollTop,o=document.querySelector('.toc'),g=o?o.querySelector('#TableOfContents'):null,A=document.getElementById('toggle-toc'),l=document.querySelector('.single__contents'),b=document.querySelector('.navbar'),t=document.querySelector('.toc__flexbox'),r=document.querySelector('.toc__flexbox--outer'),L=document.querySelectorAll('.expand__content'),K=document.querySelectorAll('.box'),e=null,C=JSON.parse("true"),h=JSON.parse('["h4","h3","h2"]'),h?h=h.toString():h="h1, h2, h3, h4, h5, h6",l&&l.querySelectorAll(".tab")?l.querySelectorAll(".tab").forEach(function(a){a.querySelectorAll(h).forEach(function(a){e=Array.isArray(e)?e.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,L?L.forEach(function(a){a.querySelectorAll(h).forEach(function(a){e=Array.isArray(e)?e.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,K?K.forEach(function(a){a.querySelectorAll(h).forEach(function(a){e=Array.isArray(e)?e.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,window.onscroll=function(){ai();var a=window.pageYOffset||document.documentElement.scrollTop;if(a>N){if(a<250?s.style.display="none":s.style.display="block",a<45)return null;b.classList.contains('scrolling')&&(b.classList.contains('navbar--hide')?b.classList.contains('navbar--show')&&b.classList.remove('navbar--show'):b.classList.add('navbar--hide')),l&&(l.querySelectorAll(h).length>0?l.querySelectorAll(h).forEach(function(c){var b,a;if(A&&!A.checked)return null;if(e&&e.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),o.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),o.querySelector('a[href="#'+b+'"]')?o.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===C||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(t&&(t.setAttribute('data-position',''),t.classList.contains('hide')||t.classList.add('hide')),r&&(r.setAttribute('data-position',''),r.classList.contains('hide')||r.classList.add('hide'))))}else a<250&&(s.style.display="none"),b.classList.contains('scrolling')&&(b.classList.contains('navbar--hide')?b.classList.remove('navbar--hide'):b.classList.contains('navbar--show')||b.classList.add('navbar--show')),l&&(l.querySelectorAll(h).length>0?l.querySelectorAll(h).forEach(function(c){var b,a;if(A&&!A.checked)return null;if(e&&e.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),o.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),o.querySelector('a[href="#'+b+'"]')?o.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===C||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(t&&!t.classList.contains('hide')&&t.classList.add('hide'),r&&!r.classList.contains('hide')&&r.classList.add('hide'))),g&&document.documentElement.scrollTop<250&&(!1===C||(g.querySelector('ul')?g.querySelector('ul').querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})}):null));N=a<=0?0:a},G=localStorage.getItem('theme'),B=document.getElementById('root'),aa=document.querySelectorAll('.select-theme'),y=document.querySelectorAll('.select-theme__item'),ar=JSON.parse('"dark"'),aq=JSON.parse('"light"'),ap=JSON.parse('"hacker"'),ao=JSON.parse('"solarized"'),an=JSON.parse('"kimbie"'),F=function(a){var b=document.getElementsByName('msapplication-TileColor')[0],c=document.getElementsByName('theme-color')[0],d=document.getElementsByName('msapplication-navbutton-color')[0],e=document.getElementsByName('apple-mobile-web-app-status-bar-style')[0];a.includes('dark')?(b.setAttribute('content','#fcfcfa'),c.setAttribute('content','#403E41'),d.setAttribute('content','#403E41'),e.setAttribute('content','#403E41')):a.includes('light')?(b.setAttribute('content','#555'),c.setAttribute('content','#eee'),d.setAttribute('content','#eee'),e.setAttribute('content','#eee')):a.includes('hacker')?(b.setAttribute('content','#e3cd26'),c.setAttribute('content','#252526'),d.setAttribute('content','#252526'),e.setAttribute('content','#252526')):a.includes('solarized')?(b.setAttribute('content','#d3af86'),c.setAttribute('content','#51412c'),d.setAttribute('content','#51412c'),e.setAttribute('content','#51412c')):a.includes('kimbie')&&(b.setAttribute('content','#586e75'),c.setAttribute('content','#eee8d5'),d.setAttribute('content','#eee8d5'),e.setAttribute('content','#eee8d5'))},am=function(a){if(a===ar)return'dark';if(a===aq)return'light';if(a===ap)return'hacker';if(a===ao)return'solarized';if(a===an)return'kimbie'},G?(y?y.forEach(function(a){a.text.trim()===G?a.classList.add('is-active'):a.classList.remove('is-active')}):null,F(G)):F(B.className),y?y.forEach(function(a,b){a.addEventListener('click',function(c){var a=am(c.target.text.trim()),b,d;localStorage.setItem('theme',a),F(a),B.removeAttribute('class'),B.classList.add('theme__'+a),aa.forEach(function(b){b.querySelectorAll('a').forEach(function(b){b.classList&&(b.text.trim()===a?b.classList.contains('is-active')||b.classList.add('is-active'):b.classList.contains('is-active')&&b.classList.remove('is-active'))})}),window.mermaid&&(a==="dark"||a==="hacker"?(mermaid.initialize({theme:'dark'}),location.reload()):(mermaid.initialize({theme:'default'}),location.reload())),b=document.getElementById('utterances'),b&&b.querySelector('iframe').contentWindow.postMessage({type:'set-theme',theme:a==="dark"||a==="hacker"?'photon-dark':a==='kimbie'?'github-dark-orange':'github-light'},'https://utteranc.es'),d=document.querySelectorAll('.twitter-timeline'),d&&window.postMessage({type:'set-twitter-theme',theme:a==='light'||a==='solarized'?'light':'dark'})})}):null,ae=JSON.parse('""'),al=JSON.parse('"/en/posts/operating-systems-virtualization-concurrency-persistence/"'),aj=JSON.parse('"/en"'),i=null,j=null,c=null,ag=JSON.parse("true"),S=JSON.parse("100"),af=JSON.parse("true"),v=JSON.parse("true"),V=JSON.parse('"main"'),W=JSON.parse('"posts"'),ad=JSON.parse('"page"'),x=null,ag&&function(){var a=new XMLHttpRequest;W==="publication"&&ad!=="page"?a.open('GET',al+"index.json"):a.open('GET',ae+aj+"/index.json"),a.setRequestHeader('Content-Type','application/json; charset=utf-8'),a.onload=function(){a.status===200?(x=new Fuse(JSON.parse(a.response.toString('utf-8')),{keys:W.includes('publication')?['title','abstract']:af?['title','description','content']:['title','description'],includeMatches:v,shouldSort:!0,threshold:.4,location:0,distance:S||100,maxPatternLength:32,minMatchCharLength:1,isCaseSensitive:!1,findAllMatches:!1,useExtendedSearch:!1}),window.fuse=x):console.error('['+a.status+']Error:',a.statusText)},a.send()}();function ab(e,a){var b=document.createElement('li'),c,d;b.className='search-result__item',c=document.createElement('a'),c.innerHTML=a.item.title,c.setAttribute('class','search-result__item--title'),c.setAttribute('href',a.item.permalink),d=document.createElement('div'),d.setAttribute('class','search-result__item--desc'),a.item.description?d.innerHTML=a.item.description:a.item.content&&(d.innerHTML=a.item.content.substring(0,225)),b.appendChild(c),b.appendChild(d),e.appendChild(b)}function ak(f,a){var e=document.createElement('li'),b,d,c;if(e.className='search-result__item',b=null,d=document.createElement('a'),d.innerHTML=a.item.title,d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri),a.matches&&a.matches.length){for(c=0;c<a.matches.length;c++)'title'===a.matches[c].key&&(d=document.createElement('a'),d.innerHTML=k(a.matches[c].value,a.matches[c].indices),d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri)),'description'===a.matches[c].key?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=k(a.item.description,a.matches[c].indices)):'content'===a.matches[c].key?b||(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=k(a.item.content.substring(0,150),a.matches[c].indices)):a.item.description?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.description):(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.content.substring(0,150));e.appendChild(d),b&&e.appendChild(b),e&&f.appendChild(e)}}function _(d,c){var a,b;for(i=document.getElementById('search-results'),j=document.getElementById('search-menu'),i.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var e=document.createElement('li'),c=document.createElement('a'),f,d;c.setAttribute('href',b.uri),c.setAttribute('class','dropdown-item'),c.appendChild(e),f=document.createElement('div'),f.innerHTML=b.title,f.setAttribute('class','menu-item__title'),d=document.createElement('div'),d.setAttribute('class','menu-item__desc'),b.description?d.innerHTML=b.description:b.content&&(d.innerHTML=b.content.substring(0,150)),e.appendChild(f),e.appendChild(d),a.appendChild(c)}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));j.hasChildNodes();)j.removeChild(j.lastChild);j.appendChild(a)}function O(d,c){var a,b;for(i=document.getElementById('search-results'),j=document.getElementById('search-menu'),i.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var g=document.createElement('li'),e=document.createElement('a'),c=null,f,d;if(e.setAttribute('href',b.item.uri),e.setAttribute('class','dropdown-item'),e.appendChild(g),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','menu-item__title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=k(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=k(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=k(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.content.substring(0,150));g.appendChild(f),c&&g.appendChild(c),a.appendChild(e)}}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));j.hasChildNodes();)j.removeChild(j.lastChild);j.appendChild(a)}function Z(e,c){var a,d;i=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length>0?c.forEach(function(b){var c=document.createElement('a');c.setAttribute('href',b.uri),c.innerHTML='<div class="mobile-search__item"><div class="mobile-search__item--title">üìÑ '+b.title+'</div><div class="mobile-search__item--desc">'+(b.description?b.description:b.content)+'</div></div>',a.appendChild(c)}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);i.appendChild(a)}function ac(e,c){var a,d;i=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length?c.forEach(function(b){var e=document.createElement('li'),g=document.createElement('a'),c=null,f,d;if(g.setAttribute('href',b.item.uri),g.appendChild(e),e.setAttribute('class','mobile-search__item'),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','mobile-search__item--title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=k(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=k(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=k(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.content.substring(0,150));e.appendChild(f),c&&e.appendChild(c),a.appendChild(g)}}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);i.appendChild(a)}function k(a,d){if(!d)return a;var b='',c=0;return d.forEach(function(d){if(d[0]===d[1])return null;b+=''+a.substring(c,d[0])+'<span class="search__highlight">'+a.substring(d[0],d[1]+1)+'</span>'+'',c=d[1]+1}),b+=a.substring(c),b}q=document.getElementById('search'),T=document.getElementById('search-mobile'),p=document.getElementById('search-results'),q?q.addEventListener('input',function(b){var a,e;if(!b.target.value|window.innerWidth<770)return p?p.setAttribute('class','dropdown'):null,d?d.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null,null;c=b.target.value,a=x.search(b.target.value),V==="main"?v?$(c,a):Q(c,a):(v?O(c,a):_(c,a),e=p.querySelectorAll('.dropdown-item'),e?e.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,q?q.addEventListener('blur',function(){if(window.innerWidth<770)return null;p?p.setAttribute('class','dropdown'):null}):null,q?q.addEventListener('click',function(b){var a,d;if(window.innerWidth<770)return null;if(!b.target.value)return p?p.setAttribute('class','dropdown'):null,null;c=b.target.value,a=x.search(b.target.value),V==="main"?v?$(c,a):Q(c,a):(v?O(c,a):_(c,a),d=p.querySelectorAll('.dropdown-item'),d?d.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,au=document.getElementById("search-menu"),at=document.querySelector('#search-menu .dropdown-item.is-active'),a=null,av=null,M=350,q?q.addEventListener('keydown',function(c){var b,e;if(window.innerWidth<770)return null;if(c.key==='Escape'&&(d?d.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b=document.querySelectorAll('#search-menu .dropdown-item'),e=c.which||c.keyCode,!b||!b.length)return null;if(c.key==='ArrowDown'||e===40){a===null?(a=0,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===b.length-1?0:a+1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-M;c>0?document.querySelector(".search-content").scrollTop+=b[a].getBoundingClientRect().height:a===0&&(document.querySelector(".search-content").scrollTop=0)}else if(c.key==='ArrowUp'||e===38){a===null?(a=b.length-1,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===0?b.length-1:a-1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-M;c<0?document.querySelector(".search-content").scrollTop-=b[a].getBoundingClientRect().height:document.querySelector(".search-content").scrollTop=c+b[a].getBoundingClientRect().height}else c.key==='Enter'||e===13?b[a]&&b[a].getAttribute('href')&&(location.href=b[a].getAttribute('href')):(c.key==='Escape'||e===27)&&(c.target.value=null,i&&i.classList.remove('is-active'))}):null,T?T.addEventListener('input',function(a){if(!a.target.value){let a=document.getElementById('search-mobile-results');while(a.firstChild)a.removeChild(a.firstChild);return null}c=a.target.value;var b=x.search(a.target.value);Z(c,b),v?ac(c,b):Z(c,b)}):null,n=document.querySelector('#search-mobile'),I=document.querySelector('.mobile-search'),H=document.querySelectorAll('.navbar-search'),J=document.querySelector('#search-mobile-close'),u=document.querySelector('#search-mobile-container'),m=document.querySelector('#search-mobile-results'),w=document.querySelector('html'),I&&(I.style.display='none'),H?H.forEach(function(a,b){a.addEventListener('click',function(){u&&(u.style.display='block'),n&&n.focus(),w&&(w.style.overflowY='hidden')})}):null,J?J.addEventListener('click',function(){if(u&&(u.style.display='none'),n&&(n.value=''),m)while(m.firstChild)m.removeChild(m.firstChild);w&&(w.style.overflowY='visible')}):null,n?n.addEventListener('keydown',function(a){var b=a.which||a.keyCode;if(a.key==='Escape'||b===27){if(u&&(u.style.display='none'),n&&(n.value=''),m)while(m.firstChild)m.removeChild(m.firstChild);w&&(w.style.overflowY='visible')}}):null;function Q(e,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),c=document.createElement('ul');e?a&&a&&a.length&&(a.forEach(function(a){ab(c,a)}),d?d.setAttribute('data-display','block'):null,f?f.setAttribute('data-display','none'):null):(d?d.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b.parentNode.replaceChild(c,b)}function $(e,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),c=document.createElement('ul');e?a&&a&&a.length&&(a.forEach(function(a){ak(c,a)}),d?d.setAttribute('data-display','block'):null,f?f.setAttribute('data-display','none'):null):(d?d.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b.parentNode.replaceChild(c,b)}})</script><link rel=stylesheet href=/css/main.min.css><meta name=description content="<Êìç‰ΩúÁ≥ªÁªü>‰∏™‰∫∫ÊëòÂΩïÁ¨îËÆ∞, Êï¥‰ΩìÊñáÊ°£Ê°ÜÊû∂Ê≤°Âèò, ÂéüËØæÁ®ãÂú®educative.io"><meta name=keywords content="Operating Systems"><meta name=created content="2021-05-22T02:35:18+0000"><meta name=modified content="2021-05-22T02:35:18+0000"><meta property="article:published_time" content="2021-05-22T02:35:18+0000"><meta name=author content="ÂàòÂÆóÂ†Ç"><meta property="og:site_name" content="ËùâËØ≠"><meta property="og:title" content="Operating Systems: Virtualization, Concurrency & Persistence"><meta property="og:url" content="/en/posts/operating-systems-virtualization-concurrency-persistence/"><meta property="og:type" content="article"><meta property="og:description" content="<Êìç‰ΩúÁ≥ªÁªü>‰∏™‰∫∫ÊëòÂΩïÁ¨îËÆ∞, Êï¥‰ΩìÊñáÊ°£Ê°ÜÊû∂Ê≤°Âèò, ÂéüËØæÁ®ãÂú®educative.io"><meta name=generator content="Hugo 0.81.0"><meta name=msapplication-TileColor content="#fff"><meta name=theme-color content="#fff"><meta name=msapplication-navbutton-color content="#fff"><meta name=apple-mobile-web-app-status-bar-style content="#fff"><link rel=canonical href=/en/posts/operating-systems-virtualization-concurrency-persistence/><link rel=manifest href=/manifest.json><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-512x512.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","headline":"Operating Systems: Virtualization, Concurrency \u0026 Persistence","datePublished":"2021-05-22T02:35:18Z","dateModified":"2021-05-22T02:35:18Z","url":"/en/posts/operating-systems-virtualization-concurrency-persistence/","description":"\u003cÊìç‰ΩúÁ≥ªÁªü\u003e‰∏™‰∫∫ÊëòÂΩïÁ¨îËÆ∞, Êï¥‰ΩìÊñáÊ°£Ê°ÜÊû∂Ê≤°Âèò, ÂéüËØæÁ®ãÂú®educative.io","keywords":["Operating Systems"],"mainEntityOfPage":{"@type":"WebPage","@id":""},"publisher":{"@type":"Organization","name":"ËùâËØ≠","url":""}}</script></head><body id=root class=theme__dark><script>var localTheme=localStorage.getItem('theme');localTheme&&(document.getElementById('root').className='theme__'+localTheme)</script><div id=container><div class=wrapper data-type=posts data-kind=page><nav class="navbar scrolling" role=navigation aria-label="main navigation" data-dir=ltr><div class=navbar__brand><a href=/en/ title=Home rel=home class=navbar__logo-link><img src=/logo.png alt=Home class=navbar__logo></a>
<a href=/en/ title=Home rel=home class=navbar__title-link><h6 class=navbar__title>ËùâËØ≠</h6></a></div><div class="theme theme-mobile" data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">dark</a>
<a href=# class="dropdown-item select-theme__item">light</a>
<a href=# class="dropdown-item select-theme__item">hacker</a></div></div></div><div class="mobile-search__btn navbar-search" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div><div id=search-mobile-container class="mobile-search hide" data-dir=ltr><div class=mobile-search__top><input id=search-mobile type=text aria-label="Mobile Search" placeholder=Search class=mobile-search__top--input><div id=search-mobile-close class=mobile-search__top--icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg></div></div><div id=search-mobile-results class=mobile-search__body></div></div><a role=button class=navbar__burger aria-label=menu aria-expanded=false data-ani=true><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><div class=navbarm__collapse data-open=false><ul dir=ltr><li class=navbarm__menu--item><a href=/en>‰∏ªÈ°µ</a></li><li class=navbarm__menu--item><a href=/en/gallery>Áõ∏ÂÜå</a></li><li class="navbarm__menu--item active"><a href=/en/posts>ÊñáÁ´†<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg></a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/en/archive>Âπ¥Êúà</a></li><li class=navbarm__menu--item><a href=/en/showcase>È°πÁõÆ</a></li><li class=navbarm__menu--item><a href=/en/publication>ÊëòÂΩï</a></li><li class=navbarm__menu--item><a href=/en/tags class=navbarm__menu--term data-index=0>Tags</a></li><li class=navbarm__menu--item><a href=/en/categories class=navbarm__menu--term data-index=1>Categories</a></li><li class=navbarm__menu--item><a href=/en/series class=navbarm__menu--term data-index=2>Series</a></li></ul></div><div class=navbar__menu><div class=theme data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">dark</a>
<a href=# class="dropdown-item select-theme__item">light</a>
<a href=# class="dropdown-item select-theme__item">hacker</a></div></div></div><a href=/en class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>‰∏ªÈ°µ</a>
<a href=/en/gallery class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>Áõ∏ÂÜå</a><div class="navbar__dropdown navbar__slide-down" data-ani=true><a href=/en/posts class="navbar__menu-item active" dir=ltr>ÊñáÁ´†<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg></a><div class=navbar__dropdown--content><a href=/en/archive class=navbar__dropdown--item dir=ltr>Âπ¥Êúà</a></div></div><a href=/en/showcase class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>È°πÁõÆ</a>
<a href=/en/publication class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>ÊëòÂΩï</a></div></nav><main class="single__main main-main"><div class=single><div class=single__nojs>This page looks best with JavaScript enabled</div><script>document.querySelector('.single').classList.remove('hide'),document.querySelector('.single__nojs').classList.add('hide')</script><h2 class=single__title data-ani=true>Operating Systems: Virtualization, Concurrency & Persistence</h2><h3 class=single__subtitle></h3><div class=single__meta><div class=single__infos><time class=single__info title="Written At">üìÖ&nbsp;May 22, 2021</time>
&nbsp;&#183;&nbsp; <span class=single__info title="Reading Time">‚òï&nbsp;25&nbsp;min read</span>
<span class=single__info></span></div><ul class="single__tags caption">üè∑Ô∏è<li><a href=/en/tags/operating-systems/ class=single__tag title="Operating Systems">#Operating Systems</a></li></ul></div><article class=single__contents data-dir=ltr data-ani=true><div class=expand><button type=button class=expand__button aria-label="Expand Button">
<span class="expand-icon expand-icon__right"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentcolor" d="M9.29 15.88 13.17 12 9.29 8.12c-.39-.39-.39-1.02.0-1.41.39-.39 1.02-.39 1.41.0l4.59 4.59c.39.39.39 1.02.0 1.41L10.7 17.3c-.39.39-1.02.39-1.41.0-.38-.39-.39-1.03.0-1.42z"/></svg></span>What's on this Page</button><div class="expand__content expand__content--toc"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#so-what-happens-when-a-program-runs>So, what happens when a program runs?</a></li><li><a href=#virtualization--the-cpu>Virtualization The CPU</a></li><li><a href=#virtualizing-memory>Virtualizing Memory</a></li><li><a href=#concurrency>Concurrency</a></li><li><a href=#persistence>Persistence</a></li><li><a href=#design-goals>Design Goals</a></li></ul></li><li><a href=#virtualization-processes>Virtualization: Processes</a><ul><li><a href=#time-sharing>Time sharing</a></li><li><a href=#policies>Policies</a></li><li><a href=#the-abstraction-a-process>The Abstraction: A Process</a></li><li><a href=#process-api>Process API</a></li><li><a href=#process-creation-a-little-more-detail>Process Creation: A Little More Detail</a></li><li><a href=#processes-states>Processes States</a></li><li><a href=#data-structures>Data Structures</a></li><li><a href=#summary>Summary</a></li></ul></li><li><a href=#virtualization-process-api>Virtualization: Process API</a><ul><li><a href=#the-fork-system-call>The fork() System Call</a><ul><li><a href=#non-deterministic-output>Non-deterministic output</a></li></ul></li><li><a href=#the-wait-system-call>The wait() System Call</a></li><li><a href=#finally-the-exec-system-call>Finally, The exec() System Call</a></li><li><a href=#why-motivating-the-api>Why? Motivating the API</a><ul><li><a href=#shell>Shell</a></li><li><a href=#pipeline>Pipeline</a></li></ul></li><li><a href=#process-control-and-users>Process Control and Users</a><ul><li><a href=#sending-signals-to-a-process>Sending signals to a process</a></li><li><a href=#giving-control-of-processes-to-users>Giving control of processes to users</a></li></ul></li></ul></li><li><a href=#virtualization-direct-execution>Virtualization: Direct Execution</a><ul><li><a href=#basic-technique-limited-direct-execution>Basic Technique: Limited Direct Execution</a></li><li><a href=#problem-1-restricted-operations>Problem #1: Restricted Operations</a><ul><li><a href=#process-modes>Process modes</a></li></ul></li><li><a href=#executing-system-calls>Executing system calls</a><ul><li><a href=#special-trap-instructions>Special trap instructions</a></li></ul></li><li><a href=#problem-2-switching-between-processes>Problem #2: Switching Between Processes</a></li><li><a href=#a-cooperative-approach-wait-for-system-calls>A cooperative approach: wait for system calls</a></li><li><a href=#a-non-cooperative-approach-the-os-takes-control>A non-cooperative approach: the OS takes control</a></li><li><a href=#saving-and-restoring-context>Saving and restoring context</a></li><li><a href=#worried-about-concurrency>Worried About Concurrency?</a><ul><li><a href=#disabling-interrupts>Disabling interrupts</a></li><li><a href=#locking-schemes>Locking schemes</a></li><li><a href=#summary-1>Summary</a></li></ul></li></ul></li><li><a href=#virtualization-cpu-scheduling>Virtualization: CPU Scheduling</a><ul><li><a href=#workload-assumptions-and-scheduling-metrics>Workload Assumptions and Scheduling Metrics</a><ul><li><a href=#workload-assumptions>Workload assumptions</a></li><li><a href=#scheduling-metrics>Scheduling metrics</a></li></ul></li><li><a href=#first-in-first-out-fifo>First In, First Out (FIFO)</a><ul><li><a href=#convoy-effect>Convoy effect</a></li></ul></li><li><a href=#shortest-job-first-sjf>Shortest Job First (SJF)</a></li><li><a href=#shortest-time-to-completion-first-stcf>Shortest Time-to-Completion First (STCF)</a></li><li><a href=#a-new-metric-response-time>A New Metric: Response Time</a><ul><li><a href=#approaches-not-sensitive-to-response-time>Approaches not sensitive to response time</a></li></ul></li><li><a href=#round-robin>Round Robin</a></li><li><a href=#incorporating-io>Incorporating I/O</a><ul><li><a href=#treating-jobs-as-independent>Treating jobs as independent</a></li><li><a href=#no-more-oracle>No more Oracle</a></li></ul></li></ul></li><li><a href=#virtualization-multi-level-feedback>Virtualization: Multi-Level Feedback</a><ul><li><a href=#mlfq-basic-rules>MLFQ: Basic Rules</a><ul><li><a href=#priority-based-rules>Priority-based rules</a></li></ul></li><li><a href=#attempt-1-how-to-change-priority>Attempt #1: How To Change Priority</a><ul><li><a href=#example-1-a-single-long-running-job>Example 1: a single long-running job</a></li><li><a href=#example-2-along-came-a-short-job>Example 2: along came a short job</a></li><li><a href=#example-3-what-about-io>Example 3: what about I/O?</a></li><li><a href=#problems-with-our-current-mlfq>Problems with our current MLFQ</a></li></ul></li><li><a href=#attempt-2-the-priority-boost>Attempt #2: The Priority Boost</a><ul><li><a href=#preventing-starvation>Preventing starvation</a></li></ul></li><li><a href=#attempt-3-better-accounting>Attempt #3: Better Accounting</a></li><li><a href=#tuning-mlfq-and-other-issues>Tuning MLFQ And Other Issues</a><ul><li><a href=#parameterizing-the-scheduler>Parameterizing the scheduler</a></li><li><a href=#other-variants-of-mlfq>Other variants of MLFQ</a></li></ul></li><li><a href=#summary-2>Summary</a></li></ul></li><li><a href=#virtualization-lottery-scheduling>Virtualization: Lottery Scheduling</a><ul><li><ul><li><a href=#basic-concept-tickets-represent-your-share>Basic Concept: Tickets Represent Your Share</a></li></ul></li><li><a href=#ticket-mechanisms>Ticket Mechanisms</a><ul><li><a href=#ticket-currency>Ticket currency</a></li><li><a href=#ticket-transfer>Ticket transfer</a></li><li><a href=#ticket-inflation>Ticket inflation</a></li></ul></li><li><a href=#implementation>Implementation</a></li><li><a href=#unfairness-metric>Unfairness metric</a><ul><li><a href=#how-to-assign-tickets>How to assign tickets?</a></li></ul></li><li><a href=#why-not-deterministic>Why Not Deterministic?</a></li><li><a href=#stride-scheduling>Stride scheduling</a><ul><li><a href=#example>Example</a></li></ul></li><li><a href=#the-linux-completely-fair-scheduler-cfs>The Linux Completely Fair Scheduler (CFS)</a><ul><li><a href=#basic-operation>Basic operation</a></li><li><a href=#the-sched_latency-parameter>The <code>sched_latency</code> parameter</a></li><li><a href=#example-1>Example</a></li><li><a href=#the-min_granularity-parameter>The <code>min_granularity</code> parameter</a></li><li><a href=#nice-level-of-a-process>Nice level of a process</a></li></ul></li></ul></li></ul></nav></div></div><h1 id=operating-systems-virtualization-concurrency--persistence>Operating Systems: Virtualization, Concurrency & Persistence</h1><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210522103825199.png alt=image-20210522103825199></p><h2 id=introduction>Introduction</h2><h3 id=so-what-happens-when-a-program-runs>So, what happens when a program runs?</h3><p>Well, a running program does one very simple thing: it executes instructions. Many millions (and these days, even billions) of times every second, the processor <strong>fetches</strong> an instruction from memory, <strong>decodes</strong> it (i.e., figures out which instruction this is), and <strong>executes</strong> it (i.e., it does the thing that it is supposed to do, like add two numbers together, access memory, check a condition, jump to a function, and so forth). After it is done with this instruction, the processor moves on to the next instruction, and so on, and so on, until the program finally completes.</p><h3 id=virtualization--the-cpu>Virtualization The CPU</h3><p>The primary way the OS does this is through a general technique that we call <strong>virtualization</strong>. That is, the OS takes a <strong>physical</strong> resource (such as the processor, or memory, or a disk) and transforms it into a more general, powerful, and easy-to-use <strong>virtual</strong> form of itself. Thus, we sometimes refer to the operating system as a <strong>virtual machine</strong>.</p><p>A typical OS, in fact, exports a few hundred <strong>system calls</strong> that are available to applications. Because the OS provides these calls to run programs, access memory and devices, and other related actions, we also sometimes say that the OS provides a <strong>standard library</strong> to applications.</p><h3 id=virtualizing-memory>Virtualizing Memory</h3><p>Memory is just an array of bytes; to <strong>read</strong> memory, one must specify an <strong>address</strong> to be able to access the data stored there; to <strong>write</strong> (or <strong>update</strong>) memory, one must also specify the data to be written to the given address.</p><p>Each process accesses its own private <strong>virtual address space</strong> (sometimes just called its <strong>address space</strong>), which the OS somehow maps onto the physical memory of the machine.</p><h3 id=concurrency>Concurrency</h3><p>When there are many concurrently executing threads within the same memory space, how can we build a correctly working program? What primitives are needed from the OS? What mechanisms should be provided by the hardware? How can we use them to solve the problems of concurrency?</p><h3 id=persistence>Persistence</h3><p>We need hardware and software to be able to store data <strong>persistently</strong>; such storage is thus critical to any system as users care a great deal about their data.</p><p>The hardware comes in the form of some kind of <strong>input/output</strong> or <strong>I/O</strong> device; in modern systems, a <strong>hard drive</strong> is a common repository for long-lived information, although <strong>solid-state drives</strong> (<strong>SSDs</strong>) are making headway in this arena as well.</p><p>The software in the operating system that usually manages the disk is called the <strong>file system</strong>; it is thus responsible for storing any <strong>files</strong> the user creates in a reliable and efficient manner on the disks of the system.</p><h3 id=design-goals>Design Goals</h3><ul><li><p><strong>Requirements</strong></p><p>So, now you have some idea of what an OS actually does: it takes physical <strong>resources</strong>, such as a CPU, memory, or disk, and <strong>virtualizes</strong> them. It handles tough and tricky issues related to <strong>concurrency</strong>. And it stores files <strong>persistently</strong>, thus making them safe over the long-term.</p></li><li><p><strong>Abstractions</strong></p><p>Abstraction makes it possible to write a large program by dividing it into small and understandable pieces, to write such a program in a high-level language like C without thinking about assembly, to write code in assembly without thinking about logic gates, and to build a processor out of gates without thinking too much about transistors.</p></li><li><p><strong>High performance: minimum cost</strong></p><p>Virtualization and making the system easy to use are well worth it, but not at any cost; thus, we must strive to provide virtualization and other OS features without excessive overheads.</p><p>These overheads arise in a number of forms: extra time (more instructions) and extra space (in memory or on disk).</p></li><li><p><strong>Protection</strong></p><p>Another goal will be to <strong>provide</strong> protection between applications, as well as between the OS and applications. Because we want to make sure that the malicious or accidental bad behavior of one does not harm others or OS.</p><p>Protection is at the heart of one of the main principles underlying an operating system, which is that of <strong>isolation</strong>; isolating processes from one another is the key to protection and thus underlies much of what an OS must do.</p></li><li><p><strong>Reliability</strong></p><p>The operating system must also run non-stop; when it fails, <em>all</em> applications running on the system fail as well.</p></li><li><p><strong>Other goals</strong></p><p><strong>energy-efficiency</strong> is important in our increasingly green world;</p><p><strong>security</strong> (an extension of protection, really) against malicious applications is critical, especially in these highly-networked times;</p><p><strong>mobility</strong> is increasingly important as OSes are run on smaller and smaller devices.</p></li></ul><h2 id=virtualization-processes>Virtualization: Processes</h2><p>The definition of a process, informally, is quite simple: it is a running program.</p><h3 id=time-sharing>Time sharing</h3><p>The OS creates this illusion by <strong>virtualizing</strong> the CPU. By running one process, then stopping it and running another, and so forth, the OS can promote the illusion that many virtual CPUs exist when in fact there is only one physical CPU (or a few).</p><p>The counterpart of time sharing is <strong>space sharing</strong>, where a resource is divided (in space) among those who wish to use it. For example, disk space is naturally a space-shared resource; once a block is assigned to a file, it is normally not assigned to another file until the user deletes the original file.</p><h3 id=policies>Policies</h3><p>Policies are algorithms for making some kind of decision within the OS. For example, given a number of possible programs to run on a CPU, which program should the OS run? A <strong>scheduling policy</strong> in the OS will make this decision, likely using historical information (e.g., which program has run more over the last minute?)</p><p>In many operating systems, a common design paradigm is to separate high-level policies from their low-level mechanisms.</p><h3 id=the-abstraction-a-process>The Abstraction: A Process</h3><p>‚Äã The abstraction provided by the OS of a running program is something we will call a <strong>process</strong>.</p><ul><li><p><strong>How memory constitutes a process?</strong></p><p>One obvious component of a <strong>machine state</strong> that comprises a process is its <em>memory</em>. Instructions lie in memory; the data that the running program reads and writes sits in memory as well. Thus the memory that the process can address (called its <strong>address space</strong>) is part of the process.</p></li><li><p><strong>Registers</strong></p><p>Also part of the process‚Äôs machine state are <em>registers</em>; many instructions explicitly read or update registers and thus clearly they are important to the execution of the process.</p><p>Note that there are some particularly special registers that form part of this machine state. For example, the <strong>program counter (PC)</strong> (sometimes called the <strong>instruction pointer</strong> or <strong>IP</strong>) tells us which instruction of the program will execute next; similarly a stack pointer and associated <strong>frame pointer</strong> are used to manage the stack for function parameters, local variables, and return addresses.</p></li></ul><h3 id=process-api>Process API</h3><ul><li><p><strong>Create</strong></p><p>An operating system must include some method to create new processes. When you type a command into the shell, or double-click on an application icon, the OS is invoked to create a new process to run the program you have indicated.</p></li><li><p><strong>Destroy</strong></p><p>As there is an interface for process creation, systems also provide an interface to destroy processes forcefully. Of course, many processes will run and just exit by themselves when complete; when they don‚Äôt, however, the user may wish to kill them, and thus an interface to halt a runaway process is quite useful.</p></li><li><p><strong>Wait</strong></p><p>Sometimes it is useful to wait for a process to stop running; thus some kind of waiting interface is often provided.</p></li><li><p><strong>Miscellaneous control</strong></p><p>For example, most operating systems provide some kind of method to suspend a process (stop it from running for a while) and then resume it (continue it running).</p></li><li><p><strong>Status</strong></p><p>There are usually interfaces to get some status information about a process as well, such as how long it has run for, or what state it is in.</p></li></ul><h3 id=process-creation-a-little-more-detail>Process Creation: A Little More Detail</h3><p>Specifically, how does the OS get a program up and running? How does process creation actually work?</p><ul><li><p><strong>Transforming a program into a process</strong></p><p>The first thing that the OS must do to run a program is to <strong>load</strong> its code and any static data (e.g., initialized variables) into memory, into the address space of the process.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210522001312274.png alt=image-20210522001312274></p></li><li><p><strong>Memory allocation</strong></p><p>Some memory must be allocated for the program‚Äôs <strong>run-time stack</strong> (or just <strong>stack</strong>). As you should likely already know, C programs use the stack for local variables, function parameters, and return addresses; the OS allocates this memory and gives it to the process.</p><p>The OS may also allocate some memory for the program‚Äôs <strong>heap</strong>. In C programs, the heap is used for explicitly requested dynamically-allocated data; programs request such space by calling <code>malloc()</code> and free it explicitly by calling <code>free()</code>.The heap is needed for data structures such as linked lists, hash tables, trees, and other interesting data structures. The heap will be small at first; as the program runs, and requests more memory via the <code>malloc()</code> library API, the OS may get involved and allocate more memory to the process to help satisfy such calls.</p></li><li><p><strong>I/O related setup</strong></p><p>By loading the code and static data into memory, creating and initializing a stack, and doing other work as related to I/O setup, the OS has now (finally) set the stage for program execution.</p></li></ul><h3 id=processes-states>Processes States</h3><ul><li><p><strong>The three states of a process</strong></p><p>In a simplified view, a process can be in one of three states:</p><p><strong>Running</strong>: In the running state, a process is running on a processor. This means it is executing instructions.</p><p><strong>Ready</strong>: In the ready state, a process is ready to run but for some reason, the OS has chosen not to run it at this given moment.</p><p><strong>Blocked</strong>: In the blocked state, a process has performed some kind of operation that makes it not ready to run until some other event takes place. A common example: when a process initiates an I/O request to a disk, it becomes blocked and thus some other process can use the processor.</p></li><li><p><strong>Transitioning from one state to another</strong></p></li></ul><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210522001346310.png alt="Process: State Transitions"></p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210522184008203.png alt=image-20210522184008203></p><h3 id=data-structures>Data Structures</h3><ul><li><p><strong>Information of a process that the OS tracks</strong></p><p>The snippet below shows what type of information an OS needs to track about each process in the xv6 kernel.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=c1>// the registers xv6 will save and restore
</span><span class=c1>// to stop and subsequently restart a process
</span><span class=c1></span><span class=k>struct</span> <span class=n>context</span> <span class=p>{</span>
  <span class=kt>int</span> <span class=n>eip</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>esp</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>ebx</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>ecx</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>edx</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>esi</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>edi</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>ebp</span><span class=p>;</span>
<span class=p>};</span>
<span class=c1>// the different states a process can be in
</span><span class=c1></span><span class=k>enum</span> <span class=n>proc_state</span> <span class=p>{</span> <span class=n>UNUSED</span><span class=p>,</span> <span class=n>EMBRYO</span><span class=p>,</span> <span class=n>SLEEPING</span><span class=p>,</span>
                  <span class=n>RUNNABLE</span><span class=p>,</span> <span class=n>RUNNING</span><span class=p>,</span> <span class=n>ZOMBIE</span> <span class=p>};</span>
<span class=c1>// the information xv6 tracks about each process
</span><span class=c1>// including its register context and state
</span><span class=c1></span><span class=k>struct</span> <span class=n>proc</span> <span class=p>{</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>mem</span><span class=p>;</span>                  <span class=c1>// Start of process memory
</span><span class=c1></span>  <span class=n>uint</span> <span class=n>sz</span><span class=p>;</span>                    <span class=c1>// Size of process memory
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>kstack</span><span class=p>;</span>               <span class=c1>// Bottom of kernel stack
</span><span class=c1></span>                              <span class=c1>// for this process
</span><span class=c1></span>  <span class=k>enum</span> <span class=n>proc_state</span> <span class=n>state</span><span class=p>;</span>      <span class=c1>// Process state
</span><span class=c1></span>  <span class=kt>int</span> <span class=n>pid</span><span class=p>;</span>                    <span class=c1>// Process ID
</span><span class=c1></span>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>parent</span><span class=p>;</span>        <span class=c1>// Parent process
</span><span class=c1></span>  <span class=kt>void</span> <span class=o>*</span><span class=n>chan</span><span class=p>;</span>                 <span class=c1>// If !zero, sleeping on chan
</span><span class=c1></span>  <span class=kt>int</span> <span class=n>killed</span><span class=p>;</span>                 <span class=c1>// If !zero, has been killed
</span><span class=c1></span>  <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>ofile</span><span class=p>[</span><span class=n>NOFILE</span><span class=p>];</span> <span class=c1>// Open files
</span><span class=c1></span>  <span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>cwd</span><span class=p>;</span>          <span class=c1>// Current directory
</span><span class=c1></span>  <span class=k>struct</span> <span class=n>context</span> <span class=n>context</span><span class=p>;</span>     <span class=c1>// Switch here to run process
</span><span class=c1></span>  <span class=k>struct</span> <span class=n>trapframe</span> <span class=o>*</span><span class=n>tf</span><span class=p>;</span>       <span class=c1>// Trap frame for the
</span><span class=c1></span>                              <span class=c1>// current interrupt
</span><span class=c1></span><span class=p>};</span>
</code></pre></td></tr></table></div></div><h3 id=summary>Summary</h3><p>the low-level mechanisms needed to implement processes, and the higher-level policies required to schedule them in an intelligent way.</p><blockquote><p><strong>ASIDE: KEY PROCESS TERMS</strong></p><ul><li>The <strong>process</strong> is the major OS abstraction of a running program. At any point in time, the process can be described by its state: the contents of memory in its <strong>address space</strong>, the contents of CPU registers (including the <strong>program counter</strong> and <strong>stack pointer</strong>, among others), and information about I/O (such as open files which can be read or written).</li><li>The <strong>process API</strong> consists of calls that programs can make related to processes. Typically, this includes creation, destruction, and other useful calls.</li><li>Processes exist in one of many different <strong>process states</strong>, including running, ready to run, and blocked. Different events (e.g., getting scheduled or descheduled, or waiting for an I/O to complete) transition a process from one of these states to the other.</li><li>A <strong>process list</strong> contains information about all processes in the system. Each entry is found in what is sometimes called a <strong>process control block (PCB)</strong>, which is really just a structure that contains information about a specific process.</li></ul></blockquote></li></ul><h2 id=virtualization-process-api>Virtualization: Process API</h2><p>What interfaces should the OS present for process creation and control? How should these interfaces be designed to enable powerful functionality, ease of use, and high performance?</p><h3 id=the-fork-system-call>The fork() System Call</h3><p>The fork() system call is used to create a new process.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>

  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello world (pid:%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>getpid</span><span class=p>());</span>
  <span class=n>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
  <span class=kt>int</span> <span class=n>rc</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
  <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>rc</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// fork failed
</span><span class=c1></span>    <span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;fork failed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>rc</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
    <span class=c1>// child (new process)
</span><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello, I am child (pid:%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>getpid</span><span class=p>());</span>
  <span class=p>}</span>
  <span class=k>else</span><span class=p>{</span>
    <span class=c1>// parent goes down this path (main)
</span><span class=c1></span>    <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=mi>999999</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){}</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello, I am parents of %d (pid:%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>rc</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>getpid</span><span class=p>());</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>//Output
</span><span class=c1>// hello world (pid:15)
</span><span class=c1>// hello, I am child (pid:16)
</span><span class=c1>// hello, I am parents of 16 (pid:15)
</span></code></pre></td></tr></table></div></div><p>The process calls the <code>fork()</code> system call, which the OS provides as a way to create a new process. The odd part: the process that is created is an <em>(almost) exact copy of the calling process</em>. That means that to the OS, it now looks like there are two copies of the program <code>p1</code> running, and both are about to return from the <code>fork()</code> system call. The newly-created process (called the <strong>child</strong>, in contrast to the creating <strong>parent</strong>) doesn‚Äôt start running at <code>main()</code> like you might expect (note, the ‚Äúhello, world‚Äù message only got printed out once); rather, it just comes into life as if it had called <code>fork()</code> itself.</p><p>Specifically, while the parent receives the PID of the newly-created child, the child receives a return code of zero. This differentiation is useful because it is simple then to write the code that handles the two different cases (as above).</p><h4 id=non-deterministic-output>Non-deterministic output</h4><p>The CPU <strong>scheduler</strong>, a topic we‚Äôll discuss in great detail soon, determines which process runs at a given moment in time; because the scheduler is complex, we cannot usually make strong assumptions about what it will choose to do, and hence which process will run first. This <strong>non-determinism</strong>, as it turns out, leads to some interesting problems, particularly in <strong>multi-threaded programs</strong>.</p><h3 id=the-wait-system-call>The wait() System Call</h3><p>It is quite useful for a parent to wait for a child process to finish what it has been doing.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/wait.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[])</span>
<span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello world (pid:%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>getpid</span><span class=p>());</span>
    <span class=n>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
    <span class=kt>int</span> <span class=n>rc</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rc</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// fork failed; exit
</span><span class=c1></span>        <span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;fork failed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>rc</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// child (new process)
</span><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello, I am child (pid:%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>getpid</span><span class=p>());</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span> <span class=c1>// parent goes down this path (main)
</span><span class=c1></span>        <span class=kt>int</span> <span class=n>rc_wait</span> <span class=o>=</span> <span class=n>wait</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello, I am parent of %d (rc_wait:%d) (pid:%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>rc</span><span class=p>,</span> <span class=n>rc_wait</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>getpid</span><span class=p>());</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// output:
</span><span class=c1>// hello world (pid:15)
</span><span class=c1>// hello, I am child (pid:16)
</span><span class=c1>// hello, I am parent of 16 (rc_wait:16) (pid:15)
</span></code></pre></td></tr></table></div></div><p>Thus, even when the parent runs first, it politely waits for the child to finish running, then <code>wait()</code> returns, and then the parent prints its message.</p><h3 id=finally-the-exec-system-call>Finally, The exec() System Call</h3><p>To run a <em>different</em> program; <code>exec()</code> does just that (see the code below).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/wait.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[]){</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello world (pid:%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>getpid</span><span class=p>());</span>
    <span class=n>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
    <span class=kt>int</span> <span class=n>rc</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rc</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// fork failed; exit
</span><span class=c1></span>        <span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;fork failed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>rc</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// child (new process)
</span><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello, I am child (pid:%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>getpid</span><span class=p>());</span>
        <span class=n>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
        <span class=kt>char</span> <span class=o>*</span><span class=n>myargs</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
        <span class=n>myargs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>strdup</span><span class=p>(</span><span class=s>&#34;wc&#34;</span><span class=p>);</span>   <span class=c1>// program: &#34;wc&#34; (word count)
</span><span class=c1></span>        <span class=n>myargs</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>strdup</span><span class=p>(</span><span class=s>&#34;p3.c&#34;</span><span class=p>);</span> <span class=c1>// argument: file to count
</span><span class=c1></span>        <span class=n>myargs</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>           <span class=c1>// marks end of array
</span><span class=c1></span>        <span class=n>execvp</span><span class=p>(</span><span class=n>myargs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>myargs</span><span class=p>);</span>  <span class=c1>// runs word count
</span><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;this shouldn&#39;t print out&#34;</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// parent goes down this path (original process)
</span><span class=c1></span>        <span class=kt>int</span> <span class=n>wc</span> <span class=o>=</span> <span class=n>wait</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello, I am parent of %d (wc:%d) (pid:%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
	       <span class=n>rc</span><span class=p>,</span> <span class=n>wc</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>getpid</span><span class=p>());</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// output
</span><span class=c1>// hello world (pid:14)
</span><span class=c1>// hello, I am child (pid:15)
</span><span class=c1>//   31  124 1008 p3.c
</span><span class=c1>// hello, I am parent of 15 (wc:15) (pid:14)
</span></code></pre></td></tr></table></div></div><p>In this example, the child process calls <code>execvp()</code> in order to run the program <code>wc</code>, which is the word counting program. In fact, it runs <code>wc</code> on the source file <code>p3.c</code>, thus telling us how many lines, words, and bytes are found in the file.</p><p>What it does: given the name of an executable (e.g., <code>wc</code>), and some arguments (e.g., <code>p3.c</code>), it <strong>loads</strong> code (and static data) from that executable and overwrites its current code segment (and current static data) with it; the heap and stack and other parts of the memory space of the program are re-initialized. Then the OS simply runs that program, passing in any arguments as the <code>argv</code> of that process. Thus, it does <em>not</em> create a new process; rather, it transforms the currently running program (formerly <code>p3</code>) into a different running program (<code>wc</code>). After the <code>exec()</code> in the child, it is almost as if <code>p3.c</code> never ran; a successful call to <code>exec()</code> never returns.</p><h3 id=why-motivating-the-api>Why? Motivating the API</h3><h4 id=shell>Shell</h4><p>The shell is just a user program.</p><p>It shows you a <strong>prompt</strong> and then waits for you to type something into it. You then type a command into it; in most cases, the shell then figures out where in the file system the executable resides, calls <code>fork()</code> to create a new child process to run the command, calls some variant of <code>exec()</code> to run the command, and then waits for the command to complete by calling <code>wait()</code>. When the child completes, the shell returns from <code>wait()</code> and prints out a prompt again, ready for your next command.</p><p>The separation of <code>fork()</code> and <code>exec()</code> allows the shell to do a whole bunch of useful things rather easily.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;assert.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/wait.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
<span class=p>{</span>
    <span class=kt>int</span> <span class=n>rc</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rc</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// fork failed; exit
</span><span class=c1></span>        <span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;fork failed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>rc</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
	<span class=c1>// child: redirect standard output to a file
</span><span class=c1></span>	<span class=n>close</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>);</span> 
	<span class=n>open</span><span class=p>(</span><span class=s>&#34;./output/p4.output&#34;</span><span class=p>,</span> <span class=n>O_CREAT</span><span class=o>|</span><span class=n>O_WRONLY</span><span class=o>|</span><span class=n>O_TRUNC</span><span class=p>,</span> <span class=n>S_IRWXU</span><span class=p>);</span>

	<span class=c1>// now exec &#34;wc&#34;...
</span><span class=c1></span>        <span class=kt>char</span> <span class=o>*</span><span class=n>myargs</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
        <span class=n>myargs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>strdup</span><span class=p>(</span><span class=s>&#34;wc&#34;</span><span class=p>);</span>   <span class=c1>// program: &#34;wc&#34; (word count)
</span><span class=c1></span>        <span class=n>myargs</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>strdup</span><span class=p>(</span><span class=s>&#34;p4.c&#34;</span><span class=p>);</span> <span class=c1>// argument: file to count
</span><span class=c1></span>        <span class=n>myargs</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>           <span class=c1>// marks end of array
</span><span class=c1></span>        <span class=n>execvp</span><span class=p>(</span><span class=n>myargs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>myargs</span><span class=p>);</span>  <span class=c1>// runs word count
</span><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// parent goes down this path (original process)
</span><span class=c1></span>        <span class=kt>int</span> <span class=n>wc</span> <span class=o>=</span> <span class=n>wait</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
	<span class=n>assert</span><span class=p>(</span><span class=n>wc</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// prompt&gt; ./p4
</span><span class=c1>// prompt&gt; cat p4.output
</span><span class=c1>//       32     109     846 p4.c
</span><span class=c1>// prompt&gt;
</span></code></pre></td></tr></table></div></div><p>The program <code>p4</code> did indeed call <code>fork()</code> to create a new child, and then run the <code>wc</code> program via a call to <code>execvp()</code>. You don‚Äôt see any output printed to the screen because it has been redirected to the file <code>p4.output</code> (present in the <code>output</code> directory). Second, you can see that when we view the output file, all the expected output from running <code>wc</code> is found. Cool, right?</p><h4 id=pipeline>Pipeline</h4><p>UNIX pipes are implemented in a similar way but with the <code>pipe()</code> system call. In this case, the output of one process is connected to an in-kernel <strong>pipe</strong> (i.e., queue), and the input of another process is connected to that same pipe; thus, the output of one process seamlessly is used as input to the next, and long and useful chains of commands can be strung together.</p><h3 id=process-control-and-users>Process Control and Users</h3><h4 id=sending-signals-to-a-process>Sending signals to a process</h4><p>Beyond <code>fork()</code>, <code>exec()</code>, and <code>wait()</code>, there are a lot of other interfaces for interacting with processes in UNIX systems. For example, the <code>kill()</code> system call is used to send <strong>signals</strong> to a process, including directives to pause, die, and other useful imperatives.</p><p>The entire signals subsystem provides a rich infrastructure to deliver external events to processes, including ways to receive and process those signals within individual processes, and ways to send signals to individual processes as well as entire <strong>process groups</strong>. To use this form of communication, a process should use the <code>signal()</code> system call to ‚Äúcatch‚Äù various signals; doing so ensures that when a particular signal is delivered to a process, it will suspend its normal execution and run a particular piece of code in response to the signal.</p><h4 id=giving-control-of-processes-to-users>Giving control of processes to users</h4><p>This naturally raises the question: who can send a signal to a process, and who cannot? Generally, the systems we use can have multiple people using them at the same time; if one of these people can arbitrarily send signals such as <strong>SIGINT</strong> (to interrupt a process, likely terminating it), the usability and security of the system will be compromised. As a result, modern systems include a strong conception of the notion of a <strong>user</strong>. The user, after entering a password to establish credentials, logs in to gain access to system resources. Users generally can only control their own processes; it is the job of the operating system to parcel out resources (such as CPU, memory, and disk) to each user (and their processes) to meet overall system goals.</p><h2 id=virtualization-direct-execution>Virtualization: Direct Execution</h2><p>By <strong>time sharing</strong> the CPU in this manner, virtualization is achieved. There are a few challenges, however, in building such virtualization machinery. The first is <em>performance</em>: how can we implement virtualization without adding excessive overhead to the system? The second is <em>control</em>: how can we run processes efficiently while retaining control over the CPU? Control is particularly important to the OS, as it is in charge of resources; without control, a process could simply run forever and take over the machine, or access information that it should not be allowed to access. Obtaining high performance while maintaining control is thus one of the central challenges in building an operating system.</p><h3 id=basic-technique-limited-direct-execution>Basic Technique: Limited Direct Execution</h3><p>To make a program run as fast as one might expect, not surprisingly OS developers came up with a technique, which we call <strong>limited direct execution</strong>.</p><p>The ‚Äúdirect execution‚Äù part of the idea is simple: just run the program directly on the CPU. Thus, when the OS wishes to start a program running, it creates a process entry for it in a process list, allocates some memory for it, loads the program code into memory (from disk), locates its entry point (i.e., the <code>main()</code> routine or something similar), jumps to it, and starts running the user‚Äôs code. The figure below shows this basic direct execution protocol (without any limits, yet), using a normal call and return to jump to the program‚Äôs <code>main()</code> and later back into the kernel.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210522153913087.png alt="Direct Execution Protocol (Without Limits)"></p><p>This approach gives rise to a few problems in our quest to virtualize the CPU.</p><ul><li>The first : if we just run a program, how can the OS make sure the program doesn‚Äôt do anything that we don‚Äôt want it to do, while still running it efficiently?</li><li>The second: when we are running a process, how does the operating system stop it from running and switch to another process, thus implementing the <strong>time sharing</strong> we require to virtualize the CPU?</li></ul><h3 id=problem-1-restricted-operations>Problem #1: Restricted Operations</h3><h4 id=process-modes>Process modes</h4><p><strong>user mode</strong>; code that runs in user mode is restricted in what it can do. For example, when running in user mode, a process can‚Äôt issue I/O requests; doing so would result in the processor raising an exception; the OS would then likely kill the process.</p><p><strong>kernel mode</strong>, which the operating system (or kernel) runs in. In this mode, code that runs can do what it likes, including privileged operations such as issuing I/O requests and executing all types of restricted instructions.</p><h3 id=executing-system-calls>Executing system calls</h3><p>What should a user process do when it wishes to perform some kind of privileged operation, such as reading from disk? To enable this, virtually all modern hardware provides the ability for user programs to perform a <strong>system call</strong>.</p><h4 id=special-trap-instructions>Special trap instructions</h4><p>To execute a system call, a program must execute a special <strong>trap</strong> instruction. This instruction simultaneously jumps into the kernel and raises the privilege level to kernel mode; once in the kernel, the system can now perform whatever privileged operations are needed (if allowed) and thus do the required work for the calling process. When finished, the OS calls a special <strong>return-from-trap</strong> instruction, which, as you might expect, returns into the calling user program while simultaneously reducing the privilege level back to user mode.</p><p>There is one important detail left out of this discussion: how does the trap know which code to run inside the OS? Clearly, the calling process can‚Äôt specify an address to jump to (as you would when making a procedure call); doing so would allow programs to jump anywhere into the kernel which clearly is a <strong>Very Bad Idea</strong>. Thus the kernel must carefully control what code executes upon a trap.</p><p>The kernel does so by setting up a <strong>trap table</strong> at boot time. When the machine boots up, it does so in privileged (kernel) mode and thus is free to configure machine hardware as need be. One of the first things the OS thus does is to tell the hardware what code to run when certain exceptional events occur.</p><p>The OS informs the hardware of the locations of these <strong>trap handlers</strong>, usually with some kind of special instruction. Once the hardware is informed, it remembers the location of these handlers until the machine is next rebooted, and thus the hardware knows what to do (i.e., what code to jump to) when system calls and other exceptional events take place.</p><blockquote><p>In general, a secure system must treat user inputs with great suspicion.</p></blockquote><p>To specify the exact system call, a <strong>system-call number</strong> is usually assigned to each system call. The user code is thus responsible for placing the desired system-call number in a register or at a specified location on the stack; the OS, when handling the system call inside the trap handler, examines this number, ensures it is valid, and, if it is, executes the corresponding code. This level of indirection serves as a form of <strong>protection</strong>; user code cannot specify an exact address to jump to, but rather must request a particular service via number.</p><p>One last aside: being able to execute the instruction to tell the hardware where the trap tables are is a very powerful capability. Thus, as you might have guessed, it is also a <strong>privileged</strong> operation.</p><p>The timeline (with time increasing downward, in the figure below) summarizes the protocol. We assume each process has a kernel stack where registers (including general-purpose registers and the program counter) are saved to and restored from (by the hardware) when transitioning into and out of the kernel.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210522175625633.png alt="Limited Direct Execution Protocol"></p><p>There are two phases in the limited direct execution (<strong>LDE</strong>) protocol. In the first (at boot time), the kernel initializes the trap table, and the CPU remembers its location for subsequent use. The kernel does so via a privileged instruction (all privileged instructions are highlighted in bold).</p><p>In the second (when running a process), the kernel sets up a few things (e.g., allocating a node on the process list, allocating memory) before using a return-from-trap instruction to start the execution of the process; this switches the CPU to user mode and begins running the process. When the process wishes to issue a system call, it traps back into the OS, which handles it and once again returns control via a return-from-trap to the process. The process then completes its work, and returns from <code>main()</code>; this usually will return into some stub code which will properly exit the program (say, by calling the <code>exit()</code> system call, which traps into the OS). At this point, the OS cleans up and we are done.</p><h3 id=problem-2-switching-between-processes>Problem #2: Switching Between Processes</h3><p>How can the operating system regain control of the CPU so that it can switch between processes?</p><h3 id=a-cooperative-approach-wait-for-system-calls>A cooperative approach: wait for system calls</h3><p>In this style, the OS <em>trusts</em> the processes of the system to behave reasonably. Processes that run for too long are assumed to periodically give up the CPU so that the OS can decide to run some other task.</p><p>In a cooperative scheduling system, the OS regains control of the CPU by waiting for a system call or an illegal operation of some kind to take place.</p><h3 id=a-non-cooperative-approach-the-os-takes-control>A non-cooperative approach: the OS takes control</h3><p>A timer device can be programmed to raise an interrupt every so many milliseconds; when the interrupt is raised, the currently running process is halted, and a pre-configured <strong>interrupt handler</strong> in the OS runs.</p><p>As we discussed before with system calls, the OS must inform the hardware of which code to run when the timer interrupt occurs; thus, at boot time, the OS does exactly that. Second, also during the boot sequence, the OS must start the timer, which is, of course, a privileged operation. Once the timer has begun, the OS can thus feel safe in that control will eventually be returned to it, and thus the OS is free to run user programs. The timer can also be turned off (also a privileged operation)</p><h3 id=saving-and-restoring-context>Saving and restoring context</h3><p>Whether to continue running the currently-running process or switch to a different one.</p><p>If the decision is made to switch, the OS then executes a low-level piece of code which we refer to as a <strong>context switch</strong>. A context switch is conceptually simple: all the OS has to do is save a few register values for the currently-executing process (onto its kernel stack, for example) and restore a few for the soon-to-be-executing process (from its kernel stack). By doing so, the OS thus ensures that when the return-from-trap instruction is finally executed, instead of returning to the process that was running, the system resumes execution of another process.</p><p>To save the context of the currently-running process, the OS will execute some low-level assembly code to save the general-purpose registers, PC, and the kernel stack pointer of the currently-running process, and then restore said registers, PC, and switch to the kernel stack for the soon-to-be-executing process. By switching stacks, the kernel enters the call to the switch code in the context of one process (the one that was interrupted) and returns in the context of another (the soon-to-be-executing one). When the OS then finally executes a return-from-trap instruction, the soon-to-be-executing process becomes the currently-running process. And thus the context switch is complete.</p><p>In this example, Process A is running and then is interrupted by the timer interrupt. The hardware saves its registers (onto its kernel stack) and enters the kernel (switching to kernel mode). In the timer interrupt handler, the OS decides to switch from running Process A to Process B. At that point, it calls the <code>switch()</code> routine, which carefully saves current register values (into the process structure of A), restores the registers of Process B (from its process structure entry), and then <strong>switches contexts</strong>, specifically by changing the stack pointer to use B‚Äôs kernel stack (and not A‚Äôs). Finally, the OS returns-from-trap, which restores B‚Äôs registers and starts running it.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523083717183.png alt="Limited Direct Execution Protocol (Timer Interrupt)"></p><p>Note that there are two types of register saves/restores that happen during this protocol. The first is when the timer interrupt occurs; in this case, the <em>user registers</em> of the running process are implicitly saved by the <em>hardware</em>, using the kernel stack of that process. The second is when the OS decides to switch from A to B; in this case, the <em>kernel registers</em> are explicitly saved by the <em>software</em> (i.e., the OS), but this time into memory in the process structure of the process. The latter action moves the system from running as if it just trapped into the kernel from A to as if it just trapped into the kernel from B.</p><p>To give you a better sense of how such a switch is enacted, the code snippet below shows the context switch code for xv6:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># void swtch(struct context **old, struct context *new); </span>
<span class=c1>#</span>
<span class=c1># Save current register context in old</span>
<span class=c1># and then load register context from new.</span>
.globl swtch
swtch: 
  <span class=c1># Save old registers</span>
  movl 4<span class=o>(</span>%esp<span class=o>)</span>, %eax <span class=c1># put old ptr into eax</span>
  popl 0<span class=o>(</span>%eax<span class=o>)</span>       <span class=c1># save the old IP</span>
  movl %esp, 4<span class=o>(</span>%eax<span class=o>)</span> <span class=c1># and stack</span>
  movl %ebx, 8<span class=o>(</span>%eax<span class=o>)</span> <span class=c1># and other registers</span>
  movl %ecx, 12<span class=o>(</span>%eax<span class=o>)</span>
  movl %edx, 16<span class=o>(</span>%eax<span class=o>)</span>
  movl %esi, 20<span class=o>(</span>%eax<span class=o>)</span>
  movl %edi, 24<span class=o>(</span>%eax<span class=o>)</span>
  movl %ebp, 28<span class=o>(</span>%eax<span class=o>)</span>

  <span class=c1># Load new registers</span>
  movl 4<span class=o>(</span>%esp<span class=o>)</span>, %eax  <span class=c1># put new ptr into eax</span>
  movl 28<span class=o>(</span>%eax<span class=o>)</span>, %ebp <span class=c1># restore other registers</span>
  movl 24<span class=o>(</span>%eax<span class=o>)</span>, %edi
  movl 20<span class=o>(</span>%eax<span class=o>)</span>, %esi
  movl 16<span class=o>(</span>%eax<span class=o>)</span>, %edx
  movl 12<span class=o>(</span>%eax<span class=o>)</span>, %ecx
  movl 8<span class=o>(</span>%eax<span class=o>)</span>, %ebx
  movl 4<span class=o>(</span>%eax<span class=o>)</span>, %esp  <span class=c1># stack is switched here</span>
  pushl 0<span class=o>(</span>%eax<span class=o>)</span>.      <span class=c1># return addr put in place</span>
  ret                 <span class=c1># finally return into new ctxt</span>
</code></pre></td></tr></table></div></div><h3 id=worried-about-concurrency>Worried About Concurrency?</h3><h4 id=disabling-interrupts>Disabling interrupts</h4><p>One simple thing an OS might do is <strong>disable interrupts</strong> during interrupt processing; doing so ensures that when one interrupt is being handled, no other one will be delivered to the CPU. Of course, the OS has to be careful in doing so; disabling interrupts for too long could lead to lost interrupts, which is (in technical terms) bad.</p><h4 id=locking-schemes>Locking schemes</h4><p>Operating systems also have developed a number of sophisticated <strong>locking</strong> schemes to protect concurrent access to internal data structures. This enables multiple activities to be on-going within the kernel at the same time, particularly useful on multiprocessors.</p><h4 id=summary-1>Summary</h4><p>We have described some key low-level mechanisms to implement CPU virtualization, a set of techniques that we collectively refer to as <strong>limited direct execution</strong>. The basic idea is straightforward: just run the program you want to run on the CPU, but first, make sure to set up the hardware so as to limit what the process can do without OS assistance.</p><p><strong>ASIDE: KEY CPU VIRTUALIZATION TERMS (MECHANISMS)</strong></p><ul><li>The CPU should support at least two modes of execution: a restricted <strong>user mode</strong> and a privileged (non-restricted) <strong>kernel mode</strong>.</li><li>Typical user applications run in user mode, and use a <strong>system call</strong> to <strong>trap</strong> into the kernel to request operating system services.</li><li>The trap instruction saves the register state carefully, changes the hardware status to kernel mode, and jumps into the OS to a pre-specified destination: the <strong>trap table</strong>.</li><li>When the OS finishes servicing a system call, it returns to the user program via another special <strong>return-from-trap</strong> instruction, which reduces privilege and returns control to the instruction after the trap that jumped into the OS.</li><li>The trap tables must be set up by the OS at boot time, and make sure that they cannot be readily modified by user programs. All of this is part of the <strong>limited direct execution</strong> protocol which runs programs efficiently but without loss of OS control.</li><li>Once a program is running, the OS must use hardware mechanisms to ensure the user program does not run forever, namely the <strong>timer interrupt</strong>. This approach is a <strong>non-cooperative approach</strong> to CPU scheduling.</li><li>Sometimes the OS, during a timer interrupt or system call, might wish to switch from running the current process to a different one, a low-level technique known as a <strong>context switch</strong>.</li></ul><h2 id=virtualization-cpu-scheduling>Virtualization: CPU Scheduling</h2><blockquote><p>How should we develop a basic framework for thinking about scheduling policies? What are the key assumptions? What metrics are important? What basic approaches have been used in the earliest of computer systems?</p></blockquote><h3 id=workload-assumptions-and-scheduling-metrics>Workload Assumptions and Scheduling Metrics</h3><h4 id=workload-assumptions>Workload assumptions</h4><p>Let us first make a number of simplifying assumptions about the processes running in the system, sometimes collectively called the <strong>workload</strong>.</p><p>We will make the following assumptions about the processes, sometimes called <strong>jobs</strong>, that are running in the system:</p><ol><li>Each job runs for the same amount of time.</li><li>All the jobs arrive at the same time.</li><li>Once started, each job runs to completion.</li><li>All jobs only use the CPU (i.e., they perform no I/O).</li><li>The run-time of each job is known.</li></ol><h4 id=scheduling-metrics>Scheduling metrics</h4><p>A metric is just something that we use to <em>measure</em> something, and there are a number of different metrics that make sense in scheduling.</p><p>The <strong>turnaround time</strong> of a job is defined as the time at which the job completes minus the time at which the job arrived in the system. More formally, the turnaround time T<sub>turnaround</sub> is:</p><p>T<sub>turnaround</sub> == T<sub>completion</sub> ‚àí T<sub>arrival</sub></p><h3 id=first-in-first-out-fifo>First In, First Out (FIFO)</h3><ul><li>Assume also that each job runs for 10 seconds.</li></ul><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523144953724.png alt=image-20210523144953724></p><p>From the figure above, you can see that A finished at 10, B at 20, and C at 30. Thus, the average turnaround time for the three jobs is:<br>$$<br>\frac{10+20+30}{3}=20<br>$$</p><ul><li>In particular, let‚Äôs again assume three jobs (A, B, and C), but this time A runs for 100 seconds while B and C run for 10 each.</li></ul><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523145513314.png alt="Why FIFO Is Not That Great"></p><p>the average turnaround time for the three jobs is:<br>$$<br>\frac{100+110+120}{3}=110<br>$$</p><h4 id=convoy-effect>Convoy effect</h4><p>The convoy effect, where a number of relatively-short potential consumers of a resource get queued behind a heavyweight resource consumer.</p><h3 id=shortest-job-first-sjf>Shortest Job First (SJF)</h3><p>It runs the shortest job first, then the next shortest, and so on.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523152122708.png alt="SJF Simple Example"></p><p>the average turnaround time for the three jobs is:<br>$$<br>\frac{10+20+120}{3}=50<br>$$<br>Here we can illustrate the problem again with an example. This time, assume A arrives at t = 0<em>t</em>=0 and needs to run for 100 seconds, whereas B and C arrive at t = 10<em>t</em>=10 and each needs to run for 10 seconds. With pure SJF, we‚Äôd get the schedule seen in the figure below.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523153711612.png alt=image-20210523153711612></p><h3 id=shortest-time-to-completion-first-stcf>Shortest Time-to-Completion First (STCF)</h3><p>To address this concern, we need to relax assumption 3 (that jobs must run to completion), so let‚Äôs do that. We also need some machinery within the scheduler itself. As you might have guessed, given our previous discussion about timer interrupts and context switching, the scheduler can certainly do something else when B and C arrive: it can <strong>preempt</strong> job A and decide to run another job, perhaps continuing A later. SJF by our definition is a <strong>non-preemptive</strong> scheduler and thus suffers from the problems described before.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523154323436.png alt="STCF Simple Example"></p><p>the average turnaround time for the three jobs is:<br>$$<br>\frac{(120‚àí0)+(20‚àí10)+(30‚àí10)}{3}=50<br>$$</p><h3 id=a-new-metric-response-time>A New Metric: Response Time</h3><p>In fact, for a number of early batch computing systems, these types of scheduling algorithms made some sense. However, the introduction of time-shared machines changed all that. Now users would sit at a terminal and demand interactive performance from the system as well. And thus, a new metric was born: <strong>response time</strong>.</p><p>We define response time as the time from when the job arrives in a system to the first time it is scheduled.</p><p>More formally: T<sub>response</sub> == T<sub>firstrun</sub> ‚àí T<sub>arrival</sub></p><p>For example, if we had the schedule above (with A arriving at time 0, and B and C at time 10), the response time of each job is as follows: 0 for job A, 0 for B, and 10 for C (average: 3.33).</p><h4 id=approaches-not-sensitive-to-response-time>Approaches not sensitive to response time</h4><p>As you might be thinking, STCF and related disciplines are not particularly good for response time. If three jobs arrive at the same time, for example, the third job has to wait for the previous two jobs to run <em>in their entirety</em> before being scheduled just once. While great for turnaround time, this approach is quite bad for response time and interactivity. Indeed, imagine sitting at a terminal, typing, and having to wait 10 seconds to see a response from the system just because some other job got scheduled in front of yours: not too pleasant.</p><h3 id=round-robin>Round Robin</h3><p>The basic idea is simple: instead of running jobs to completion, RR runs a job for a <strong>time slice</strong> (sometimes called a <strong>scheduling quantum</strong>) and then switches to the next job in the run queue. For this reason, RR is sometimes called <strong>time-slicing</strong>. Note that the length of a time slice must be a multiple of the timer-interrupt period; thus if the timer interrupts every 10 milliseconds, the time slice could be 10, 20, or any other multiple of 10 ms.</p><p>Assume three jobs A<em>A</em>, B<em>B</em>, and C<em>C</em> arrive at the same time in the system, and that they each wish to run for 5 seconds. SJF Again (Bad for Response Time)</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523161542703.png alt="SJF Again (Bad for Response Time)"></p><p>In contrast, RR with a time-slice of 1 second would cycle through the jobs quickly. Check out the figure below:</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523161614177.png alt="Round Robin (Good For Response Time)"></p><p>The average response time of RR is: $\frac{0+1+2}3=1$ ; for SJF, average response time is: $\frac{0+5+10}3=5$.</p><p>As you can see, the length of the time slice is critical for RR. The shorter it is, the better the performance of RR under the response-time metric. However, making the time slice too short is problematic: suddenly the cost of context switching will dominate overall performance. Thus, deciding on the length of the time slice presents a trade-off to a system designer, making it long enough to <strong>amortize</strong> the cost of switching without making it so long that the system is no longer responsive.</p><p>Note that the cost of context switching does not arise solely from the OS actions of saving and restoring a few registers. When programs run, they build up a great deal of state in CPU caches, TLBs, branch predictors, and other on-chip hardware. Switching to another job causes this state to be flushed and a new state relevant to the currently-running job to be brought in, which may exact a noticeable performance cost.</p><h3 id=incorporating-io>Incorporating I/O</h3><p>A scheduler clearly has a decision to make when a job initiates an I/O request, because the currently-running job won‚Äôt be using the CPU during the I/O; it is <strong>blocked</strong> waiting for I/O completion. If the I/O is sent to a hard disk drive, the process might be blocked for a few milliseconds or longer, depending on the current I/O load of the drive. Thus, the scheduler should probably schedule another job on the CPU at that time.</p><p><em>A</em> and B<em>B</em>, which each need 50 ms of CPU time. However, there is one obvious difference: A<em>A</em> runs for 10 ms and then issues an I/O request (assume here that I/Os each take 10ms ), whereas B<em>B</em> simply uses the CPU for 50 ms and performs no I/O. The scheduler runs A<em>A</em> first, then B<em>B</em> after (see the figure below).</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523171734219.png alt="Poor Use Of Resources"></p><h4 id=treating-jobs-as-independent>Treating jobs as independent</h4><p>A common approach is to treat each 10-ms sub-job of A<em>A</em> as an independent job.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523172401093.png alt="Overlap Allows Better Use Of Resources"></p><p>We see how a scheduler might incorporate I/O. By treating each CPU burst as a job, the scheduler makes sure processes that are ‚Äúinteractive‚Äù get run frequently. While those interactive jobs are performing I/O, other CPU-intensive jobs run, thus better utilizing the processor.</p><h4 id=no-more-oracle>No more Oracle</h4><p>With a basic approach to I/O in place, we come to our final assumption: that the scheduler knows the length of each job. As we said before, this is likely the worst assumption we could make. In fact, in a general-purpose OS (like the ones we care about), the OS usually knows very little about the length of each job. So, how can we build an approach that behaves like SJF/STCF without such a <em>priori</em> knowledge? Further, how can we incorporate some of the ideas we have seen with the RR scheduler so that response time is also quite good?</p><h2 id=virtualization-multi-level-feedback>Virtualization: Multi-Level Feedback</h2><p>The Multi-level Feedback Queue (MLFQ) scheduler was first described by Corbato et al. in 1962 in a system known as the Compatible Time-Sharing System (CTSS).</p><blockquote><p><strong>THE CRUX: HOW TO SCHEDULE WITHOUT PERFECT KNOWLEDGE?</strong></p><p>How can we design a scheduler that both minimizes response time for interactive jobs while also minimizing turnaround time without <em>a priori</em> knowledge of job length?</p></blockquote><h3 id=mlfq-basic-rules>MLFQ: Basic Rules</h3><h4 id=priority-based-rules>Priority-based rules</h4><p>In our treatment, the MLFQ has a number of distinct <strong>queues</strong>, each assigned a different <strong>priority level</strong>. At any given time, a job that is ready to run is in a single queue. MLFQ uses priorities to decide which job should run at a given time: a job with higher priority (i.e., a job on a higher queue) is chosen to run. Of course, more than one job may be in a given queue and thus have the <em>same</em> priority. In this case, we will just use round-robin scheduling among those jobs.</p><p>Thus, we arrive at the first two basic rules for MLFQ:</p><ul><li><strong>Rule 1</strong>: If Priority(A) > Priority(B), A runs (B doesn‚Äôt).</li><li><strong>Rule 2</strong>: If Priority(A) = Priority(B), A & B run in RR.</li></ul><p>The key to MLFQ scheduling, therefore, lies in how the scheduler sets priorities. Rather than giving a fixed priority to each job, MLFQ <em>varies</em> the priority of a job based on its <em>observed behavior</em>. If, for example, a job repeatedly relinquishes the CPU while waiting for input from the keyboard, MLFQ will keep its priority high, as this is how an interactive process might behave. If instead, a job uses the CPU intensively for long periods of time, MLFQ will reduce its priority. In this way, MLFQ will try to <em>learn</em> about processes as they run, and thus use the <em>history</em> of the job to predict its <em>future</em> behavior.</p><h3 id=attempt-1-how-to-change-priority>Attempt #1: How To Change Priority</h3><p>Here is our first attempt at a priority-adjustment algorithm:</p><ul><li><strong>Rule 3</strong>: When a job enters the system, it is placed at the highest priority (the topmost queue).</li><li><strong>Rule 4a</strong>: If a job uses up an entire time slice while running, its priority is <em>reduced</em> (i.e., it moves down one queue).</li><li><strong>Rule 4b</strong>: If a job gives up the CPU before the time slice is up, it stays at the <em>same</em> priority level.</li></ul><h4 id=example-1-a-single-long-running-job>Example 1: a single long-running job</h4><p>Let‚Äôs look at some examples. First, we‚Äôll look at what happens when there has been a long-running job in the system. The figure below shows what happens to this job over time in a three-queue scheduler.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523204817803.png alt="Long-running Job Over Time"></p><p>As you can see in the example, the job enters at the highest priority (Q2). After a single time-slice of 10 ms, the scheduler reduces the job‚Äôs priority by one, and thus the job is on Q1. After running at Q1 for a time slice, the job is finally lowered to the lowest priority in the system (Q0), where it remains. Pretty simple, no?</p><h4 id=example-2-along-came-a-short-job>Example 2: along came a short job</h4><p>The figure provided below plots the results of this scenario. A (shown in black) is running along in the lowest-priority queue (as would any long-running CPU-intensive jobs); B (shown in gray) arrives at time T = 100 and thus is inserted into the highest queue; as its run-time is short (only 20 ms), B completes before reaching the bottom queue, in two time slices; then A resumes running (at low priority).</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523205353595.png alt="Along Came An Interactive Job"></p><p>From this example, you can hopefully understand one of the major goals of the algorithm: because it doesn‚Äôt <em>know</em> whether a job will be a short job or a long-running job, it first <em>assumes</em> it might be a short job, thus giving the job high priority. If it actually is a short job, it will run quickly and complete; if it is not a short job, it will slowly move down the queues, and thus soon prove itself to be a long-running more batch-like process. In this manner, MLFQ approximates SJF.</p><h4 id=example-3-what-about-io>Example 3: what about I/O?</h4><p>The intent of this rule is simple: if an interactive job, for example, is doing a lot of I/O (say by waiting for user input from the keyboard or mouse), it will relinquish the CPU before its time slice is complete; in such case, we don‚Äôt wish to penalize the job and thus simply keep it at the same level.</p><p>The figure below shows an example of how this works, with an interactive job B (shown in gray) that needs the CPU only for 1 ms before performing an I/O competing for the CPU with a long-running batch job A (shown in black). The MLFQ approach keeps B at the highest priority because B keeps releasing the CPU; if B is an interactive job, MLFQ further achieves its goal of running interactive jobs quickly.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523210127839.png alt="A Mixed I/O-intensive and CPU-intensive Workload"></p><h4 id=problems-with-our-current-mlfq>Problems with our current MLFQ</h4><p>First, there is the problem of <strong>starvation</strong>: if there are ‚Äútoo many‚Äù interactive jobs in the system, they will combine to consume <em>all</em> CPU time, and thus long-running jobs will <em>never</em> receive any CPU time (they <strong>starve</strong>). We‚Äôd like to make some progress on these jobs even in this scenario.</p><p>Second, a smart user could rewrite their program to <strong>game the scheduler</strong>. Gaming the scheduler generally refers to the idea of doing something sneaky to trick the scheduler into giving you more than your fair share of the resource. The algorithm we have described is susceptible to the following attack: before the time slice is over, issue an I/O operation (to some file you don‚Äôt care about) and thus relinquish the CPU; doing so allows you to remain in the same queue, and thus gain a higher percentage of CPU time. When done right (e.g., by running for 99% of a time slice before relinquishing the CPU), a job could nearly monopolize the CPU.</p><p>Finally, a program may <em>change its behavior</em> over time; what was CPU- bound may transition to a phase of interactivity. With our current approach, such a job would be out of luck and not be treated like the other interactive jobs in the system.</p><h3 id=attempt-2-the-priority-boost>Attempt #2: The Priority Boost</h3><h4 id=preventing-starvation>Preventing starvation</h4><ul><li><strong>Rule 5</strong>: After some time period S, move all the jobs in the system to the topmost queue.</li></ul><p>Our new rule solves two problems at once. First, processes are guaranteed not to starve: by sitting in the top queue, a job will share the CPU with other high-priority jobs in a round-robin fashion, and thus eventually receive service. Second, if a CPU-bound job has become interactive, the scheduler treats it properly once it has received the priority boost.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523211911941.png alt="Without (Left) and With (Right) Priority Boost"></p><p>On the left, there is no priority boost, and thus the long-running job gets starved once the two short jobs arrive; on the right, there is a priority boost every 50 ms (which is likely too small of a value, but used here for the example), and thus we at least guarantee that the long-running job will make some progress, getting boosted to the highest priority every 50 ms and thus getting to run periodically.</p><p>What should S be set to?Unfortunately, S has that flavor. If it is set too high, long-running jobs could starve; too low, and interactive jobs may not get a proper share of the CPU.</p><h3 id=attempt-3-better-accounting>Attempt #3: Better Accounting</h3><p>We now have one more problem to solve: how to prevent gaming of our scheduler?</p><p>The solution here is to perform better <strong>accounting</strong> of CPU time at each level of the MLFQ. Instead of forgetting how much of a time slice a process used at a given level, the scheduler should keep track; once a process has used its allotment, it is demoted to the next priority queue. Whether it uses the time slice in one long burst or many small ones does not matter. We thus rewrite Rules 4a and 4b to the following single rule:</p><ul><li><strong>Rule 4</strong>: Once a job uses up its time allotment at a given level (regardless of how many times it has given up the CPU), its priority is reduced (i.e., it moves down one queue).</li></ul><p>Without (Left) and With (Right) Gaming Tolerance:</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210523222852265.png alt="Without (Left) and With (Right) Gaming Tolerance"></p><p>Without any protection from gaming, a process can issue an I/O just before a time slice ends and thus dominate CPU time. With such protections in place, regardless of the I/O behavior of the process, it slowly moves down the queues, and thus cannot gain an unfair share of the CPU.</p><h3 id=tuning-mlfq-and-other-issues>Tuning MLFQ And Other Issues</h3><h4 id=parameterizing-the-scheduler>Parameterizing the scheduler</h4><p>A few other issues arise with MLFQ scheduling. One big question is how to <strong>parameterize</strong> such a scheduler. For example, how many queues should there be? How big should the time slice be per queue? How often should priority be boosted in order to avoid starvation and account for changes in behavior? There are no easy answers to these questions, and thus only some experience with workloads and subsequent tuning of the scheduler will lead to a satisfactory balance.</p><p>For example, most MLFQ variants allow for varying time-slice length across different queues. The high-priority queues are usually given short time slices; they consist of interactive jobs, after all, and thus quickly alternating between them makes sense (e.g., 10 or fewer milliseconds). The low-priority queues, in contrast, contain long-running jobs that are CPU-bound; hence, longer time slices work well (e.g., 100s of ms).</p><p>The figure below shows an example in which two jobs run for 20 ms at the highest queue (with a 10-ms time slice), 40 ms in the middle (20-ms time slice), and with a 40-ms time slice at the lowest.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210524080850417.png alt="Lower Priority, Longer Quanta"></p><h4 id=other-variants-of-mlfq>Other variants of MLFQ</h4><p>Default values for the table are 60 queues, with slowly increasing time-slice lengths from 20 milliseconds (highest priority) to a few hundred milliseconds (lowest), and priorities boosted around every 1 second or so.</p><p>Other MLFQ schedulers don‚Äôt use a table or the exact rules described in this chapter; rather they adjust priorities using mathematical formulae.</p><p>Finally, many schedulers have a few other features that you might encounter. For example, some schedulers reserve the highest priority levels for operating system work; thus typical user jobs can never obtain the highest levels of priority in the system. Some systems also allow some user <strong>advice</strong> to help set priorities; for example, by using the command-line utility, you can increase or decrease the priority of a job (somewhat) and thus increase or decrease its chances of running at any given time. See the man page for more.</p><h3 id=summary-2>Summary</h3><p>The refined set of MLFQ rules, spread throughout the chapter, are reproduced here for your viewing pleasure:</p><ul><li><strong>Rule 1</strong>: If <em>Priority</em>(A) > <em>Priority</em>(B), <em>A</em> runs (<em>B</em> doesn‚Äôt).</li><li><strong>Rule 2</strong>: If <em>Priority</em>(A) = <em>Priority</em>(B), <em>A</em> & <em>B</em> run in round-robin fashion using the time slice (quantum length) of the given queue.</li><li><strong>Rule 3</strong>: When a job enters the system, it is placed at the highest priority (the topmost queue).</li><li><strong>Rule 4</strong>: Once a job uses up its time allotment at a given level (regardless of how many times it has given up the CPU), its priority is reduced (i.e., it moves down one queue).</li><li><strong>Rule 5</strong>: After some time period S, move all the jobs in the system to the topmost queue.</li></ul><p>MLFQ is interesting for the following reason: instead of demanding <em>a priori</em> knowledge of the nature of a job, it observes the execution of a job and prioritizes it accordingly. In this way, it manages to achieve the best of both worlds: it can deliver excellent overall performance (similar to SJF/STCF) for short-running interactive jobs, and is fair and makes progress for long-running CPU-intensive workloads.</p><h2 id=virtualization-lottery-scheduling>Virtualization: Lottery Scheduling</h2><p><strong>Proportional-share</strong>, also sometimes referred to as a <strong>fair-share</strong> scheduler, is based around a simple concept: instead of optimizing for turnaround or response time, a scheduler might instead try to guarantee that each job obtains a certain percentage of CPU time.</p><h4 id=basic-concept-tickets-represent-your-share>Basic Concept: Tickets Represent Your Share</h4><p>Underlying lottery scheduling is one very basic concept: <strong>tickets</strong>, which are used to represent the share of a resource that a process (or user or whatever) should receive. The percent of tickets that a process has represents its share of the system resource in question.</p><p>Assuming A<em>A</em> holds tickets 0 through 74 and B<em>B</em> 75 through 99, the winning ticket simply determines whether A<em>A</em> or B<em>B</em> runs. The scheduler then loads the state of that winning process and runs it.</p><blockquote><p><strong>TIP: USE RANDOMNESS</strong></p><p>One of the most beautiful aspects of lottery scheduling is its use of <strong>randomness</strong>. When you have to make a decision, using such a randomized approach is often a robust and simple way of doing so.</p><p>Random approaches have at least three advantages over more traditional decisions. First, random often avoids strange corner-case behaviors that a more traditional algorithm may have trouble handling. For example, consider the LRU replacement policy (studied in more detail in a future chapter on virtual memory); while often a good replacement algorithm, LRU attains worst-case performance for some cyclic-sequential workloads. Random, on the other hand, has no such worst case.</p><p>Second, random also is lightweight, requiring little state to track alternatives. In a traditional fair-share scheduling algorithm, tracking how much CPU each process has received requires per-process accounting, which must be updated after running each process. Doing so randomly necessitates only the most minimal of per-process state (e.g., the number of tickets each has).</p><p>Finally, random can be quite fast. As long as generating a random number is quick, making the decision is also, and thus random can be used in a number of places where speed is required. Of course, the faster the need, the more random tends towards pseudo-random.</p></blockquote><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210524095738153.png alt=image-20210524095738153></p><blockquote><p><strong>TIP: USE TICKETS TO REPRESENT SHARES</strong></p><p>One of the most powerful (and basic) mechanisms in the design of lottery (and stride) scheduling is that of the <strong>ticket</strong>. The ticket is used to represent a process‚Äôs share of the CPU in these examples but can be applied much more broadly. For example, in more recent work on virtual memory management for hypervisors, Waldspurger shows how tickets can be used to represent a guest operating system‚Äôs share of memory. Thus, if you are ever in need of a mechanism to represent a proportion of ownership, this concept just might be ‚Ä¶ (wait for it) ‚Ä¶ the ticket.</p></blockquote><h3 id=ticket-mechanisms>Ticket Mechanisms</h3><h4 id=ticket-currency>Ticket currency</h4><p>Lottery scheduling also provides a number of mechanisms to manipulate tickets in different and sometimes useful ways. One way is with the concept of <strong>ticket currency</strong>. Currency allows a user with a set of tickets to allocate tickets among their own jobs in whatever currency they would like; the system then automatically converts said currency into the correct global value.</p><p>For example, assume users A and B have each been given 100 tickets. User A is running two jobs, A1 and A2, and gives them each 500 tickets (out of 1000 total) in A‚Äôs currency. User B is running only 1 job and gives it 10 tickets (out of 10 total).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-txt data-lang=txt> User A -&gt; 500 (A‚Äôs currency) to A1 -&gt;  50 (global currency)
        -&gt; 500 (A‚Äôs currency) to A2 -&gt;  50 (global currency)
 User B -&gt;  10 (B‚Äôs currency) to B1 -&gt; 100 (global currency)
</code></pre></td></tr></table></div></div><h4 id=ticket-transfer>Ticket transfer</h4><p>Another useful mechanism is <strong>ticket transfer</strong>. With transfers, a process can temporarily hand off its tickets to another process. This ability is especially useful in a client/server setting, where a client process sends a message to a server asking it to do some work on the client‚Äôs behalf. To speed up the work, the client can pass the tickets to the server and thus try to maximize the performance of the server while the server is handling the client‚Äôs request. When finished, the server then transfers the tickets back to the client and all is as before.</p><h4 id=ticket-inflation>Ticket inflation</h4><p>Finally, <strong>ticket inflation</strong> can sometimes be a useful technique. With inflation, a process can temporarily raise or lower the number of tickets it owns. Of course, in a competitive scenario with processes that do not trust one another, this makes little sense; one greedy process could give itself a vast number of tickets and take over the machine. Rather, inflation can be applied in an environment where a group of processes trusts one another; in such a case, if anyone process knows it needs more CPU time, it can boost its ticket value as a way to reflect that need to the system, all without communicating with any other processes.</p><h3 id=implementation>Implementation</h3><p>Let‚Äôs assume we keep the processes in a list. Here is an example of three processes, A, B, and C, each with some number of tickets.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210524102355215.png alt=image-20210524102355215></p><p>To make a scheduling decision, we first have to pick a random number (the winner) from the total number of tickets (400). Let‚Äôs say we pick the number 300. Then, we simply traverse the list, with a simple counter used to help us find the winner. Have a look at the code below:</p><p>Lottery Scheduling Decision Code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=c1>// counter: used to track if we‚Äôve found the winner yet
</span><span class=c1></span><span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

<span class=c1>// winner: use some call to a random number generator to
</span><span class=c1>//         get a value, between 0 and the total # of tickets
</span><span class=c1></span>
<span class=kt>int</span> <span class=n>winner</span> <span class=o>=</span> <span class=n>getrandom</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>totaltickets</span><span class=p>);</span>
<span class=c1>// current: use this to walk through the list of jobs
</span><span class=c1></span><span class=n>node_t</span> <span class=o>*</span><span class=n>current</span> <span class=o>=</span> <span class=n>head</span><span class=p>;</span>
<span class=k>while</span> <span class=p>(</span><span class=n>current</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>counter</span> <span class=o>=</span> <span class=n>counter</span> <span class=o>+</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>tickets</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>counter</span> <span class=o>&gt;</span> <span class=n>winner</span><span class=p>)</span>
      <span class=k>break</span><span class=p>;</span> <span class=c1>// found the winner
</span><span class=c1></span>  <span class=n>current</span> <span class=o>=</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
<span class=p>}</span>
<span class=c1>// ‚Äôcurrent‚Äô is the winner: schedule it...
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table></div></div><p>The code walks the list of processes, adding each ticket value to counter until the value exceeds <code>winner</code>. Once that is the case, the current list element is the winner. With our example of the winning ticket being 300, the following takes place. First, <code>counter</code> is incremented to 100 to account for A‚Äôs tickets; because 100 is less than 300, the loop continues. Then <code>counter</code> would be updated to 150 (B‚Äôs tickets), still less than 300 and thus again we continue. Finally, <code>counter</code> is updated to 400 (clearly greater than 300), and thus we break out of the loop with <code>current</code> pointing at C (the winner).</p><p>To make this process the most efficient, it might generally be best to organize the list in sorted order, from the highest number of tickets to the lowest. The ordering does not affect the correctness of the algorithm; however, it does ensure in general that the fewest number of list iterations are taken, especially if there are a few processes that possess most of the tickets.</p><h3 id=unfairness-metric>Unfairness metric</h3><p>We‚Äôd like for each job to finish at roughly the same time, but due to the randomness of lottery scheduling, sometimes one job finishes before the other. To quantify this difference, we define a simple <strong>unfairness metric</strong>, U<em>U</em> which is simply the time the first job completes divided by the time that the second job completes. For example, if R = 10<em>R</em>=10, and the first job finishes at time 10 (and the second job at 20), $U = \frac {10}{20} =0.5$. When both jobs finish at nearly the same time, <em>U</em> will be 20 quite close to 1. In this scenario, that is our goal: a perfectly fair scheduler would achieve <em>U</em>=1.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210524110038510.png alt="Lottery Fairness Study"></p><p>As you can see from the graph, when the job length is not very long, the average unfairness can be quite severe. Only as the jobs run for a significant number of time slices does the lottery scheduler approach the desired outcome.</p><h4 id=how-to-assign-tickets>How to assign tickets?</h4><p>However, this solution is a non-solution: it really doesn‚Äôt tell you what to do. Thus, given a set of jobs, the ‚Äúticket-assignment problem‚Äù remains open.</p><h3 id=why-not-deterministic>Why Not Deterministic?</h3><p>As we saw above, while randomness gets us a simple (and approximately correct) scheduler, it occasionally will not deliver the exact right proportions, especially over short time scales. For this reason, Waldspurger invented stride scheduling, a deterministic fair-share scheduler.</p><h3 id=stride-scheduling>Stride scheduling</h3><p>Stride scheduling is also straightforward. Each job in the system has a stride, which is inverse in proportion to the number of tickets it has. In the example discussed previously, with jobs A, B, and C, with 100, 50, and 250 tickets, respectively, we can compute the stride of each by dividing some large number by the number of tickets each process has been assigned. For example, if we divide 10,000 by each of those ticket values, we obtain the following stride values for A, B, and C: 100, 200, and 40. We call this value the <strong>stride</strong> of each process; every time a process runs, we will increment a counter for it (called its <strong>pass</strong> value) by its stride to track its global progress.</p><p>The scheduler then uses the stride and pass to determine which process should run next. The basic idea is simple: at any given time, pick the process to run that has the lowest pass value so far; when you run a process, increment its pass counter by its stride. A pseudocode implementation is provided by Waldspurger:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=n>curr</span> <span class=o>=</span> <span class=n>remove_min</span><span class=p>(</span><span class=n>queue</span><span class=p>);</span>   <span class=c1>// pick client with min pass
</span><span class=c1></span><span class=n>schedule</span><span class=p>(</span><span class=n>curr</span><span class=p>);</span>             <span class=c1>// run for quantum
</span><span class=c1></span><span class=n>curr</span><span class=o>-&gt;</span><span class=n>pass</span> <span class=o>+=</span> <span class=n>curr</span><span class=o>-&gt;</span><span class=n>stride</span><span class=p>;</span> <span class=c1>// update pass using stride
</span><span class=c1></span><span class=n>insert</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span> <span class=n>curr</span><span class=p>);</span>        <span class=c1>// return curr to queue
</span></code></pre></td></tr></table></div></div><h4 id=example>Example</h4><p>In our example, we start with three processes (A, B, and C), with stride values of 100, 200, and 40, and all with pass values initially at 0. Thus, at first, any of the processes might run, as their pass values are equally low. Assume we pick A (arbitrarily; any of the processes with equal low pass values can be chosen). A runs; when finished with the time slice, we update its pass value to 100. Then we run B, whose pass value is then set to 200. Finally, we run C, whose pass value is incremented to 40. At this point, the algorithm will pick the lowest pass value, which is C‚Äôs, and run it, updating its pass to 80 (C‚Äôs stride is 40, as you recall). Then C will run it, updating run again (still the lowest pass value), raising its pass to 120. A will run now, updating its pass to 200 (now equal to B‚Äôs). Then C will run twice more, updating its pass to 160 then 200. At this point, all pass values are equal again, and the process will repeat, ad infinitum.</p><p>The figure below traces the behavior of the scheduler over time.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210524124312513.png alt="Stride Scheduling: A Trace"></p><p>Lottery scheduling achieves the proportions probabilistically over time; stride scheduling gets them exactly right at the end of each scheduling cycle.</p><p>So you might be wondering: given the precision of stride scheduling, why use lottery scheduling at all? Well, <strong>lottery scheduling</strong> has one nice property that stride scheduling does not: <strong>no global state</strong>. Imagine a new job enters in the middle of our stride scheduling example above; what should its pass value be? Should it be set to 0? If so, it will monopolize the CPU. With lottery scheduling, there is no global state per process; we simply add a new process with whatever tickets it has, update the single global variable to track how many total tickets we have and go from there. In this way, the lottery makes it much easier to incorporate new processes in a sensible manner.</p><p>ËÄåÊ≠•ÈïøË∞ÉÂ∫¶ÁöÑÁº∫ÁÇπÂàôÊòØÔºåÂú®Êñ∞ËøõÁ®ãÂä†ÂÖ•Êó∂ÔºåÂÆÉÁöÑË°åÁ®ãÂÄº‰∏∫0Ôºå‰ºö‰ΩøÂæóÂÆÉÈïøÊó∂Èó¥Áã¨Âç†CPU</p><h3 id=the-linux-completely-fair-scheduler-cfs>The Linux Completely Fair Scheduler (CFS)</h3><p>The scheduler, entitled the Completely Fair Scheduler (or CFS), implements fair-share scheduling but does so in a highly efficient and scalable manner. Reducing that overhead as much as possible is thus a key goal in modern scheduler architecture.</p><h4 id=basic-operation>Basic operation</h4><p>Whereas most schedulers are based around the concept of a fixed time slice, CFS operates a bit differently. Its goal is simple: to fairly divide a CPU evenly among all competing processes. It does so through a simple counting-based technique known as <strong>virtual runtime</strong> (<strong>vruntime</strong>).</p><p>As each process runs, it accumulates <code>vruntime</code>. In the most basic case, each process‚Äôs <code>vruntime</code> increases at the same rate, in proportion with physical (real) time. When a scheduling decision occurs, CFS will pick the process with the <em>lowest</em> <code>vruntime</code> to run next.</p><p>This raises a question: how does the scheduler know when to stop the currently running process, and run the next one? The tension here is clear: if CFS switches too often, fairness is increased, as CFS will ensure that each process receives its share of CPU even over minuscule time windows, but at the cost of performance (too much context switching); if CFS switches less often, performance is increased (reduced context switching), but at the cost of near-term fairness.</p><h4 id=the-sched_latency-parameter>The <code>sched_latency</code> parameter</h4><p>CFS manages this tension through various control parameters. The first is <strong><code>sched_latency</code></strong>. CFS uses this value to determine how long one process should run before considering a switch (effectively determining its time slice but in a dynamic fashion). A typical <code>sched_latency</code> value is 48 (milliseconds); CFS divides this value by the number (<em>n</em>) of processes running on the CPU to determine the time slice for a process, and thus ensures that over this period of time, CFS will be completely fair.</p><h4 id=example-1>Example</h4><p>The figure below shows an example where the four jobs (A, B, C, D) each run for two time slices in this fashion; two of them (C, D) then complete, leaving just two remaining, which then each run for 24 ms in round-robin fashion.</p><p><img src=https://gitee.com/JohntunLiu/pic-go/raw/master/img/image-20210524130601737.png alt="CFS Simple Example"></p><p>But what if there are ‚Äútoo many‚Äù processes running? Wouldn‚Äôt that lead to too small of a time slice, and thus too many context switches? Good question! And the answer is yes.</p><h4 id=the-min_granularity-parameter>The <code>min_granularity</code> parameter</h4><p>To address this issue, CFS adds another parameter, <strong><code>min_granularity</code></strong>, which is usually set to a value like 6 ms. CFS will never set the time slice of a process to less than this value, ensuring that not too much time is spent in scheduling overhead.</p><p>Note that CFS utilizes a periodic timer interrupt, which means it can only make decisions at fixed time intervals. This interrupt goes off frequently (e.g., every 1 ms), giving CFS a chance to wake up and determine if the current job has reached the end of its run. If a job has a time slice that is not a perfect multiple of the timer interrupt interval, that is OK; CFS tracks <code>vruntime</code> precisely, which means that over the long haul, it will eventually approximate ideal sharing of the CPU.</p><h4 id=nice-level-of-a-process>Nice level of a process</h4><p>CFS also enables controls over process priority, enabling users or administrators to give some processes a higher share of the CPU. It does this not with tickets, but through a classic UNIX mechanism known as the <em>nice</em> level of a process. The nice parameter can be set anywhere from -20 to +19 for a process, with a default of 0. Positive nice values imply <em>lower</em> priority and negative values imply <em>higher</em> priority; when you‚Äôre too nice, you just don‚Äôt get as much (scheduling) attention, alas.</p><p>CFS maps the nice value of each process to a <code>weight</code>, as shown here:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>prio_to_weight</span><span class=p>[</span><span class=mi>40</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
    <span class=cm>/* -20 */</span> <span class=mi>88761</span><span class=p>,</span> <span class=mi>71755</span><span class=p>,</span> <span class=mi>56483</span><span class=p>,</span> <span class=mi>46273</span><span class=p>,</span> <span class=mi>36291</span><span class=p>,</span> 
    <span class=cm>/* -15 */</span> <span class=mi>29154</span><span class=p>,</span> <span class=mi>23254</span><span class=p>,</span> <span class=mi>18705</span><span class=p>,</span> <span class=mi>14949</span><span class=p>,</span> <span class=mi>11916</span><span class=p>,</span> 
    <span class=cm>/* -10 */</span> <span class=mi>9548</span><span class=p>,</span> <span class=mi>7620</span><span class=p>,</span> <span class=mi>6100</span><span class=p>,</span> <span class=mi>4904</span><span class=p>,</span> <span class=mi>3906</span><span class=p>,</span> 
    <span class=cm>/* -5 */</span> <span class=mi>3121</span><span class=p>,</span> <span class=mi>2501</span><span class=p>,</span> <span class=mi>1991</span><span class=p>,</span> <span class=mi>1586</span><span class=p>,</span> <span class=mi>1277</span><span class=p>,</span> 
    <span class=cm>/* 0 */</span> <span class=mi>1024</span><span class=p>,</span> <span class=mi>820</span><span class=p>,</span> <span class=mi>655</span><span class=p>,</span> <span class=mi>526</span><span class=p>,</span> <span class=mi>423</span><span class=p>,</span> 
    <span class=cm>/* 5*/</span> <span class=mi>335</span><span class=p>,</span> <span class=mi>272</span><span class=p>,</span> <span class=mi>215</span><span class=p>,</span> <span class=mi>172</span><span class=p>,</span> <span class=mi>137</span><span class=p>,</span> 
    <span class=cm>/* 10 */</span> <span class=mi>110</span><span class=p>,</span> <span class=mi>87</span><span class=p>,</span> <span class=mi>70</span><span class=p>,</span> <span class=mi>56</span><span class=p>,</span> <span class=mi>45</span><span class=p>,</span> 
    <span class=cm>/*15*/</span> <span class=mi>36</span><span class=p>,</span> <span class=mi>29</span><span class=p>,</span> <span class=mi>23</span><span class=p>,</span> <span class=mi>18</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span>
<span class=p>};</span>
</code></pre></td></tr></table></div></div><p>These weights allow us to compute the effective time slice of each process (as we did before), but now accounting for their priority differences. The formula used to do so is as follows:<br>$$<br>timeslice_k = \frac {weight_k}{\sum_{i=0}^{n-1} {weight_i}}<br>¬∑ sched_latency<br>$$</p></article><script defer src=/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js></script><script defer src=/js/helper/prev.min.js></script><script defer src=/js/helper/prop.min.js></script><script>'use strict';document.addEventListener('DOMContentLoaded',function(){var a=!1,b=document.querySelectorAll('pre.chroma'),c=document.querySelectorAll('.language-code'),d=document.querySelectorAll('div.language-\\$'),e=document.querySelectorAll('div.language-\\>'),f=function(c){var k=c,b=c.textContent,j,g,h,i,d,f,e;if(b.length>15){a||(j=new ClipboardJS('.copy-to-clipboard',{text:function(a){var c=prev(a).querySelectorAll('code');return c.length>1?b=prev(a).querySelector('code[class^="language-"]').textContent:b=prev(a).querySelector('code').textContent,b.replace(/^\$\s/gm,'')}}),j.on('success',function(a){a.clearSelection(),g=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label','Copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),j.on('error',function(a){g=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label',a.action.toString()),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),a=!0),h=['language-mermaid','language-viz','language-wave','language-chart','language-msc','language-flowchart'],i=!1,d=k.getAttribute('class');for(f=0;f<h.length;f++)if(d&&d.startsWith(h[f])){i=!0;break}i||d&&(e=document.createElement('span'),e.setAttribute('class','copy-to-clipboard'),e.setAttribute('title','Copy to clipboard'),c.parentNode.parentNode.insertBefore(e,c.parentNode.nextElementSibling))}},g=function(b){var a=document.createElement('span');a.setAttribute('class','copy-to-clipboard'),a.setAttribute('title','Copy to clipboard'),b.parentNode.parentNode.insertBefore(a,b.parentNode.nextElementSibling)};b?b.forEach(function(a){a.querySelectorAll('code').forEach(function(a){f(a)})}):null,c?c.forEach(function(a){a.querySelectorAll('code').forEach(function(a){f(a)})}):null,d?d.forEach(function(a){a.querySelectorAll('code').forEach(function(a){g(a)})}):null,e?e.forEach(function(a){a.querySelectorAll('code').forEach(function(a){g(a)})}):null})</script><script>'use strict';var langCodeElem,dollarCodeElem,gtCodeElem;function wrap(a,b){a.parentNode.insertBefore(b,a),b.appendChild(a)}(function(){var a=document.querySelector('.single__contents');a?a.querySelectorAll('pre > code').forEach(function(b){var a=b.getAttribute('data-lang'),c=document.createElement('div'),e=null,d=null;a&&a.includes(':')?(e=a.split(':')[0],d=a.split(':')[1],c.className='language-'+e,c.setAttribute('data-lang',d),b.className='language-'+e,b.setAttribute('data-lang',d),b.setAttribute('id',d)):a||(c.setAttribute('data-lang','Code'),c.className='language-code'),(!a||d)&&wrap(b.parentNode,c)}):null})(),langCodeElem=document.querySelectorAll('.language-code'),langCodeElem?langCodeElem.forEach(function(b){var a=document.createElement('span');a.className='copy-to-clipboard',a.setAttribute('title','Copy to clipboard'),b.append(a)}):null,dollarCodeElem=document.querySelectorAll('div.language-\\$'),gtCodeElem=document.querySelectorAll('div.language-\\>'),dollarCodeElem?dollarCodeElem.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='$<br/>'}):null}):null,gtCodeElem?gtCodeElem.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='><br/>'}):null}):null</script><div class=donation><div class=donation__message>Support the author with</div><div class=donation__icons><div class="donation__item donation__dropup" title=alipay aria-label=alipay data-type=donation><svg fill="#000" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="35" height="35"><path fill="#00a1e9" d="M5 5V27H27V5H5zM7 7H25V18.931641l-6.070312-2.15625C19.528069 15.604874 19.872428 14.319295 20 13H17V12h4V11H17V9H15v2H10v1h5v1H11v1h7.042969C17.874523 14.798238 17.595556 15.553113 17.226562 16.220703 17.067744 16.141588 16.909631 16.060926 16.748047 15.988281 16.275047 15.769281 15.785203 15.594937 15.283203 15.460938c-1.002-.275001000000001-2.034359-.430985-3.068359-.458985C11.955844 14.994953 11.6955 15.005813 11.4375 15.007812 11.1535 15.021812 10.861031 15.045953 10.582031 15.126953 10.020031 15.271953 9.5026563 15.571516 9.0976562 15.978516c-.8469999.798-1.1948281 1.990859-1.0488281 3.130859.125 1.176 1.034875 2.255578 2.1718749 2.642578C10.770703 21.960953 11.416641 22.039422 11.931641 21.982422 12.202641 21.976422 12.472188 21.956297 12.742188 21.904297 13.013188 21.866297 13.281922 21.822234 13.544922 21.740234c1.063-.271000000000001 2.06114-.809203 2.86914-1.533203C16.818062 19.845031 17.187578 19.452297 17.517578 19.029297 17.673578 18.811297 17.84375 18.601328 17.96875 18.361328 17.986598 18.324421 17.999073 18.284503 18.017578 18.248047L25 22.044922V25H7V7zm4.427734 9.341797L12.109375 16.388672C13.020375 16.473672 13.909156 16.711516 14.785156 16.978516 15.220156 17.122516 15.651125 17.283172 16.078125 17.451172 16.169125 17.488172 16.257656 17.530313 16.347656 17.570312 16.265656 17.685312 16.183703 17.800109 16.095703 17.912109 15.835703 18.249109 15.532328 18.544703 15.236328 18.845703c-.6.591000000000001-1.308234 1.072438-2.115234 1.398438C12.921094 20.332141 12.710094 20.385547 12.496094 20.435547 12.284094 20.499547 12.06575 20.534594 11.84375 20.558594 11.37975 20.644594 11.008375 20.634062 10.609375 20.539062 9.834375 20.367062 9.1521562 19.755547 9.0351562 18.935547 8.8801563 18.121547 9.246 17.233016 9.875 16.791016 10.182 16.559016 10.534719 16.428234 10.886719 16.365234 11.064719 16.330234 11.241734 16.336797 11.427734 16.341797z"/></svg><div class=donation__dropup--content><img data-src=/images/pay/alipay.png alt="alipay QR Code" src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" class=lazyload></div></div><div class="donation__item donation__dropup" title=wechat aria-label=wechat data-type=donation><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="35" height="35"><path fill="#8bc34a" d="M18 6C9.2 6 2 12 2 19.5c0 4.3 2.3 8 6 10.5l-2 6 6.3-3.9C14 32.7 16 33 18 33c8.8.0 16-6 16-13.5S26.8 6 18 6z"/><path fill="#7cb342" d="M20 29c0-6.1 5.8-11 13-11 .3.0.6.0.9.0-.1-.7-.3-1.4-.5-2-.1.0-.3.0-.4.0-8.3.0-15 5.8-15 13 0 1.4.3 2.7.7 4 .7.0 1.4-.1 2.1-.2C20.3 31.6 20 30.3 20 29z"/><path fill="#cfd8dc" d="M46 29c0-6.1-5.8-11-13-11-7.2.0-13 4.9-13 11s5.8 11 13 11c1.8.0 3.5-.3 5-.8l5 2.8-1.4-4.8C44.3 35.2 46 32.3 46 29z"/><path fill="#33691e" d="M14 15c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm10-2c-1.1.0-2 .9-2 2s.9 2 2 2 2-.9 2-2S25.1 13 24 13z"/><path fill="#546e7a" d="M30 26.5c0 .8-.7 1.5-1.5 1.5S27 27.3 27 26.5s.7-1.5 1.5-1.5S30 25.7 30 26.5zM37.5 25c-.8.0-1.5.7-1.5 1.5s.7 1.5 1.5 1.5 1.5-.7 1.5-1.5S38.3 25 37.5 25z"/></svg><div class=donation__dropup--content><img data-src=/images/pay/WeChatPay.png alt="wechat QR Code" src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" class=lazyload></div></div></div></div><section class=related></section><div class=grow></div><nav class=pagination-single><a href=/en/posts/course-online-project/mybatis-yml/ class=pagination-single__left><div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03.0-1.42s-1.02-.39-1.41.0l-6.59 6.59c-.39.39-.39 1.02.0 1.41l6.59 6.59c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L7.83 13H19c.55.0 1-.45 1-1s-.45-1-1-1z"/></svg></div><div class=pagination-single__left-title>MybatisÊó•ÂøóÂºÄÂêØymlËÆæÁΩÆ</div></a><div class=grow></div></nav><div class="modal micromodal-slide" id=modal aria-hidden=true><div class=modal__overlay tabindex=-1 data-micromodal-close><div class=modal__container role=dialog aria-modal=true aria-labelledby=modal-title><div class=modal__content id=modal-content><div id=mySwipe class=swipe><div class=swipe-wrap></div></div></div><span class=modal__items><span class=modal__header><div class=modal__paging title="Page Info" aria-label="Current Page"></div><div class="modal__icon modal__toolbar modal__toolbar--close" title=Close aria-label="Close Button" data-micromodal-close><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentcolor" d="M21.734375 19.640625l-2.097656 2.09375C19.253906 22.121094 18.628906 22.121094 18.242188 21.734375L13 16.496094 7.761719 21.734375C7.375 22.121094 6.746094 22.121094 6.363281 21.734375l-2.097656-2.09375c-.386719-.386718999999999-.386719-1.011719.0-1.398437L9.503906 13 4.265625 7.761719c-.382812-.390625-.382812-1.019531.0-1.398438L6.363281 4.265625C6.746094 3.878906 7.375 3.878906 7.761719 4.265625L13 9.507813l5.242188-5.242188c.386718000000002-.386719 1.015625-.386719 1.394531.0l2.097656 2.09375C22.121094 6.746094 22.121094 7.375 21.738281 7.761719L16.496094 13l5.238281 5.242188C22.121094 18.628906 22.121094 19.253906 21.734375 19.640625z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--full" title="Full Screen" aria-label="Full Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentcolor" d="M5 3C3.9069372 3 3 3.9069372 3 5V8A1.0001 1.0001.0 105 8V5H8A1.0001 1.0001.0 108 3H5zM16 3a1.0001 1.0001.0 100 2h3V8a1.0001 1.0001.0 102 0V5C21 3.9069372 20.093063 3 19 3H16zM3.984375 14.986328A1.0001 1.0001.0 003 16v3c0 1.093063.9069372 2 2 2H8a1.0001 1.0001.0 100-2H5V16A1.0001 1.0001.0 003.984375 14.986328zm16 0A1.0001 1.0001.0 0019 16v3H16a1.0001 1.0001.0 100 2h3C20.093063 21 21 20.093063 21 19V16a1.0001 1.0001.0 00-1.015625-1.013672z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--normal" title="Normal Screen" aria-label="Normal Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentcolor" d="M16.96875 4.972656C15.867188 4.988281 14.984375 5.894531 15 7v8H7C6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 5.609375 18.632813 6.277344 19.011719 7 19H19V7C19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656zm16 0c-1.046875.015625-1.90625.839844-1.964844 1.886719C31 6.90625 31 6.953125 31 7V19H43C43.066406 19 43.132813 19 43.199219 18.992188 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 44.964844 15.828125 44.074219 14.988281 43 15H35V7C35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656zM7 31C6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 5.609375 34.632813 6.277344 35.011719 7 35h8v8C14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 18.632813 44.390625 19.011719 43.722656 19 43V31zm24 0V43C30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 34.632813 44.390625 35.011719 43.722656 35 43V35h8C43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 44.390625 31.367188 43.722656 30.988281 43 31z"/></svg></div></span><div class="modal__icon modal__arrow modal__arrow--left" title="Arrow Left" aria-label="Arrow Left Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M23.28125 11 10 10V6.851563C10 6.523438 9.839844 6.277344 9.519531 6.03125 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281c-3.28125 2.296875-6.402344 6.144532-6.480469 6.308594-.078125.15625-.152343.390625-.15625.554688000000001C2.003906 12.980469 2 12.988281 2 12.992188 2 13.15625 2.078125 13.402344 2.160156 13.484375 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 9.839844 19.722656 10 19.476563 10 19.148438V16l13.28125-1C23.679688 14.679688 24 13.875 24 12.992188 24 12.195313 23.761719 11.320313 23.28125 11z"/></svg></div><div class="modal__icon modal__arrow modal__arrow--right" title="Arrow Right" aria-label="Arrow Right Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M2.71875 11.023438l13.28125-1V6.875C16 6.546875 16.160156 6.300781 16.480469 6.054688 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719c3.28125 2.296875 6.402344 6.144531 6.480469 6.308594.078125.15625.152343999999999.390625.15625.554687C23.996094 13.003906 24 13.011719 24 13.015625 24 13.179688 23.921875 13.425781 23.839844 13.507813 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 16.160156 19.746094 16 19.5 16 19.171875V16.023438L2.71875 15.023438C2.320313 14.703125 2 13.898438 2 13.015625c0-.796875.238281-1.671875.71875-1.992187z"/></svg></div><div class=modal__caption><div class=modal__caption--text></div></div></span></div></div></div><script defer src=/js/swipe.min.989e074dfb92ce7f57a92c1df7027f88b53c50a54fd9ad450a673a64aa91bfa4.js></script><script defer src=/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js></script><script defer src=/js/helper/fadeinout.min.js></script><script>document.addEventListener('DOMContentLoaded',function(){var d=document.documentElement,g,f,s,r,m,o,l,b,c,i,n,e,h,j,a,p,q;function t(){d.requestFullscreen?d.requestFullscreen():d.mozRequestFullScreen?d.mozRequestFullScreen():d.webkitRequestFullscreen?d.webkitRequestFullscreen():d.msRequestFullscreen&&d.msRequestFullscreen()}function k(){(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}g=document.getElementById('modal'),f=document.querySelector('.gallery__container'),s=document.querySelector('.swipe-wrap'),r=document.getElementById('mySwipe'),m=document.querySelector('.modal__arrow--left'),o=document.querySelector('.modal__arrow--right'),l=document.querySelector('.modal__toolbar--close'),b=document.querySelector('.modal__toolbar--full'),c=document.querySelector('.modal__toolbar--normal'),i=document.querySelector('.modal__caption'),n=document.querySelector('.modal__paging'),e=document.querySelector('.modal__items'),h=null,j=null,a=null,p=function(b){b.key==='ArrowRight'?g&&g.classList.contains('is-open')&&a.next():b.key==='ArrowLeft'&&g&&g.classList.contains('is-open')&&a.prev()},f?h=f.querySelectorAll('img').length:(f=document.querySelector('.single__contents'),h=f.querySelectorAll('img').length),MicroModal.init({onClose:function(){a&&(a.kill(),a=null,k()),window.removeEventListener('keydown',p)},disableScroll:!0,disableFocus:!0,awaitOpenAnimation:!1,awaitCloseAnimation:!1,debugMode:!1}),q=function(a){return new Promise(function(c,d){var b=new Image;b.onload=function(){c(b)},b.onerror=d,b.src=a})},f.querySelectorAll('img').forEach(function(g,k){var f,d;g.style.cursor='pointer',f=g.cloneNode(!0),f.style.maxHeight='100%',f.style.maxWidth='100%',f.onclick=function(a){a.stopPropagation()},d=document.createElement('div'),d.style.width='100%',d.style.height='100vh',d.setAttribute('data-micromodal-close',''),d.onclick=function(){a&&(a.kill(),a=null)},d.onmouseenter=function(){clearTimeout(j),fadeIn(e,200)},d.onmouseleave=function(){j=setTimeout(function(){fadeOut(e,200)},2500)},d.ontouchstart=function(){fadeIn(e,200)},d.append(f),s.append(d),g.addEventListener('click',async function(d){var m,l,g;MicroModal.show('modal'),a&&(a.kill(),a=null),m=d.target.getAttribute('data-src')||d.target.getAttribute('src'),l=await q(m),f.style.width=l.width+'px',f.style.height=l.height+'px',a=new Swipe(r,{startSlide:k,draggable:!0,autoRestart:!1,continuous:!1,disableScroll:!0,stopPropagation:!0,callback:async function(d,f){var a=f.querySelector('img'),g=a.getAttribute('data-src')||a.getAttribute('src'),c=await q(g),b;a.style.width=c.width+'px',a.style.height=c.height+'px',i&&a&&(b=null,a.getAttribute('data-caption')?b=a.getAttribute('data-caption'):a.getAttribute('title')?b=a.getAttribute('title'):a.getAttribute('alt')?b=a.getAttribute('alt'):b=a.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=b,n.innerText=d+1+' / '+h,clearTimeout(j),fadeIn(e,200))}}),fadeIn(e),i&&(g=null,d.target.getAttribute('data-caption')?g=d.target.getAttribute('data-caption'):d.target.getAttribute('title')?g=d.target.getAttribute('title'):d.target.getAttribute('alt')?g=d.target.getAttribute('alt'):g=d.target.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=g,n.innerText=k+1+' / '+h),c&&b&&(c.style.zIndex=-1,c.style.opacity=0,b.style.zIndex=25,b.style.opacity=1)}),window.addEventListener('keydown',p)}),m?m.addEventListener('click',function(b){a&&a.prev()}):null,o?o.addEventListener('click',function(b){a&&a.next()}):null,l?l.addEventListener('click',function(){a&&(a.kill(),a=null),k(),MicroModal.close('modal')}):null,b?b.addEventListener('click',function(a){t(),c&&(c.style.zIndex=25,c.style.opacity=1,b.style.zIndex=-1,b.style.opacity=0)}):null,c?c.addEventListener('click',function(a){k(),b&&(b.style.zIndex=25,b.style.opacity=1,c.style.zIndex=-1,c.style.opacity=0)}):null})</script><div class=hide><div class=search><span class=icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></span><input id=search aria-label="Site Search" class=input type=text placeholder=Search autocomplete=off><div id=search-results class=dropdown><div id=search-menu class=dropdown-menu role=menu></div></div></div></div></div></main><aside class="single__side main-side"><section class="sidebar hide"><script>document.querySelector('.sidebar').classList.remove('hide')</script><div class=toc__flexbox data-position=fixed><h6 class=toc__title data-ani=true>What's on this Page</h6><label class=switch data-ani=true><input id=toggle-toc aria-label="Toggle TOC" type=checkbox checked>
<span class="slider round"></span></label></div><div class=toc data-dir=ltr data-folding=true data-ani=true><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#so-what-happens-when-a-program-runs>So, what happens when a program runs?</a></li><li><a href=#virtualization--the-cpu>Virtualization The CPU</a></li><li><a href=#virtualizing-memory>Virtualizing Memory</a></li><li><a href=#concurrency>Concurrency</a></li><li><a href=#persistence>Persistence</a></li><li><a href=#design-goals>Design Goals</a></li></ul></li><li><a href=#virtualization-processes>Virtualization: Processes</a><ul><li><a href=#time-sharing>Time sharing</a></li><li><a href=#policies>Policies</a></li><li><a href=#the-abstraction-a-process>The Abstraction: A Process</a></li><li><a href=#process-api>Process API</a></li><li><a href=#process-creation-a-little-more-detail>Process Creation: A Little More Detail</a></li><li><a href=#processes-states>Processes States</a></li><li><a href=#data-structures>Data Structures</a></li><li><a href=#summary>Summary</a></li></ul></li><li><a href=#virtualization-process-api>Virtualization: Process API</a><ul><li><a href=#the-fork-system-call>The fork() System Call</a><ul><li><a href=#non-deterministic-output>Non-deterministic output</a></li></ul></li><li><a href=#the-wait-system-call>The wait() System Call</a></li><li><a href=#finally-the-exec-system-call>Finally, The exec() System Call</a></li><li><a href=#why-motivating-the-api>Why? Motivating the API</a><ul><li><a href=#shell>Shell</a></li><li><a href=#pipeline>Pipeline</a></li></ul></li><li><a href=#process-control-and-users>Process Control and Users</a><ul><li><a href=#sending-signals-to-a-process>Sending signals to a process</a></li><li><a href=#giving-control-of-processes-to-users>Giving control of processes to users</a></li></ul></li></ul></li><li><a href=#virtualization-direct-execution>Virtualization: Direct Execution</a><ul><li><a href=#basic-technique-limited-direct-execution>Basic Technique: Limited Direct Execution</a></li><li><a href=#problem-1-restricted-operations>Problem #1: Restricted Operations</a><ul><li><a href=#process-modes>Process modes</a></li></ul></li><li><a href=#executing-system-calls>Executing system calls</a><ul><li><a href=#special-trap-instructions>Special trap instructions</a></li></ul></li><li><a href=#problem-2-switching-between-processes>Problem #2: Switching Between Processes</a></li><li><a href=#a-cooperative-approach-wait-for-system-calls>A cooperative approach: wait for system calls</a></li><li><a href=#a-non-cooperative-approach-the-os-takes-control>A non-cooperative approach: the OS takes control</a></li><li><a href=#saving-and-restoring-context>Saving and restoring context</a></li><li><a href=#worried-about-concurrency>Worried About Concurrency?</a><ul><li><a href=#disabling-interrupts>Disabling interrupts</a></li><li><a href=#locking-schemes>Locking schemes</a></li><li><a href=#summary-1>Summary</a></li></ul></li></ul></li><li><a href=#virtualization-cpu-scheduling>Virtualization: CPU Scheduling</a><ul><li><a href=#workload-assumptions-and-scheduling-metrics>Workload Assumptions and Scheduling Metrics</a><ul><li><a href=#workload-assumptions>Workload assumptions</a></li><li><a href=#scheduling-metrics>Scheduling metrics</a></li></ul></li><li><a href=#first-in-first-out-fifo>First In, First Out (FIFO)</a><ul><li><a href=#convoy-effect>Convoy effect</a></li></ul></li><li><a href=#shortest-job-first-sjf>Shortest Job First (SJF)</a></li><li><a href=#shortest-time-to-completion-first-stcf>Shortest Time-to-Completion First (STCF)</a></li><li><a href=#a-new-metric-response-time>A New Metric: Response Time</a><ul><li><a href=#approaches-not-sensitive-to-response-time>Approaches not sensitive to response time</a></li></ul></li><li><a href=#round-robin>Round Robin</a></li><li><a href=#incorporating-io>Incorporating I/O</a><ul><li><a href=#treating-jobs-as-independent>Treating jobs as independent</a></li><li><a href=#no-more-oracle>No more Oracle</a></li></ul></li></ul></li><li><a href=#virtualization-multi-level-feedback>Virtualization: Multi-Level Feedback</a><ul><li><a href=#mlfq-basic-rules>MLFQ: Basic Rules</a><ul><li><a href=#priority-based-rules>Priority-based rules</a></li></ul></li><li><a href=#attempt-1-how-to-change-priority>Attempt #1: How To Change Priority</a><ul><li><a href=#example-1-a-single-long-running-job>Example 1: a single long-running job</a></li><li><a href=#example-2-along-came-a-short-job>Example 2: along came a short job</a></li><li><a href=#example-3-what-about-io>Example 3: what about I/O?</a></li><li><a href=#problems-with-our-current-mlfq>Problems with our current MLFQ</a></li></ul></li><li><a href=#attempt-2-the-priority-boost>Attempt #2: The Priority Boost</a><ul><li><a href=#preventing-starvation>Preventing starvation</a></li></ul></li><li><a href=#attempt-3-better-accounting>Attempt #3: Better Accounting</a></li><li><a href=#tuning-mlfq-and-other-issues>Tuning MLFQ And Other Issues</a><ul><li><a href=#parameterizing-the-scheduler>Parameterizing the scheduler</a></li><li><a href=#other-variants-of-mlfq>Other variants of MLFQ</a></li></ul></li><li><a href=#summary-2>Summary</a></li></ul></li><li><a href=#virtualization-lottery-scheduling>Virtualization: Lottery Scheduling</a><ul><li><ul><li><a href=#basic-concept-tickets-represent-your-share>Basic Concept: Tickets Represent Your Share</a></li></ul></li><li><a href=#ticket-mechanisms>Ticket Mechanisms</a><ul><li><a href=#ticket-currency>Ticket currency</a></li><li><a href=#ticket-transfer>Ticket transfer</a></li><li><a href=#ticket-inflation>Ticket inflation</a></li></ul></li><li><a href=#implementation>Implementation</a></li><li><a href=#unfairness-metric>Unfairness metric</a><ul><li><a href=#how-to-assign-tickets>How to assign tickets?</a></li></ul></li><li><a href=#why-not-deterministic>Why Not Deterministic?</a></li><li><a href=#stride-scheduling>Stride scheduling</a><ul><li><a href=#example>Example</a></li></ul></li><li><a href=#the-linux-completely-fair-scheduler-cfs>The Linux Completely Fair Scheduler (CFS)</a><ul><li><a href=#basic-operation>Basic operation</a></li><li><a href=#the-sched_latency-parameter>The <code>sched_latency</code> parameter</a></li><li><a href=#example-1>Example</a></li><li><a href=#the-min_granularity-parameter>The <code>min_granularity</code> parameter</a></li><li><a href=#nice-level-of-a-process>Nice level of a process</a></li></ul></li></ul></li></ul></nav></div></section></aside><script>var enableToc=JSON.parse("true"),toc=JSON.parse("null"),tocPosition=JSON.parse('""'),singleMainElem=document.querySelector('.single__main'),singleSideElem=document.querySelector('.single__side');enquire.register("screen and (max-width: 769px)",{match:function(){(enableToc||toc)&&tocPosition!=="outer"?singleMainElem&&singleSideElem&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main'),singleSideElem.classList.remove('main-side'),singleSideElem.classList.add('hide')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide'))},unmatch:function(){var b,a;(enableToc||toc)&&tocPosition!=="outer"?(singleMainElem.classList.remove('main'),singleMainElem.classList.add('main-main'),singleSideElem.classList.remove('hide'),singleSideElem.classList.add('main-side')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide')),b=document.querySelector('.navbar__burger'),a=document.getElementsByClassName('navbarm__collapse')[0],a&&(a.setAttribute('data-open',!1),a.style.maxHeight=0,b.classList.remove('is-active')),document.getElementsByClassName('navbar__menu')[0].classList.remove('is-active'),document.getElementsByClassName('mobile-search')[0].classList.add('hide')},setup:function(){},deferSetup:!0,destroy:function(){}})</script><script defer src=/js/helper/getParents.min.js></script><script defer src=/js/helper/closest.min.js></script><script defer src=/js/helper/prev.min.js></script><script defer src=/js/helper/prop.min.js></script><script defer src=/js/helper/fadeinout.min.js></script><script defer src=/js/helper/throttle.min.js></script><script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:['script','noscript','style','textarea','pre'],ignoreHtmlClass:'tex2jax_ignore',processHtmlClass:'tex2jax_process'}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js id=MathJax-script></script><script>'use strict';window.onload=function(){var f=document.querySelector('.navbar'),D=document.querySelector('.single__contents'),E=JSON.parse("false"),J=JSON.parse("true"),s,H,F,L,k,j,A,g,u,x,d,e,l,i,I,C,K,v,N,y,r,z,b,w,t,M,h,c,G,a,m,n,o,p,B,q;E&&J&&(s=document.querySelector('#busuanzi_value_page_pv'),s.textContent=s.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),H=JSON.parse("true"),F=JSON.parse("null"),L=JSON.parse("false"),k=document.querySelector('.toc__flexbox'),j=document.querySelector('.toc__flexbox--outer'),A=JSON.parse("true"),(H||F)&&document.querySelector('.toc')&&(g=document.querySelector('.toc').querySelector('#TableOfContents'),g.onmouseenter=function(){f.classList.contains('scrolling')&&f.classList.remove('scrolling')},g.onmouseleave=function(){f.classList.contains('scrolling')||f.classList.add('scrolling')},!1===A||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),g&&(g.querySelectorAll('a').length>0?g.querySelectorAll('a').forEach(function(a){a.addEventListener('click',function(){var c=a.getAttribute('id'),b;f.classList.contains('scrolling')||(f.classList.remove('navbar--show'),f.classList.remove('navbar--hide'),f.classList.add('navbar--hide')),document.querySelector('.toc').querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),a.classList.add('active'),b=g.querySelector('[href="#'+c+'"]'),b&&b.nextElementSibling&&(b.nextElementSibling.style.display='block'),b&&(getParents(b,'ul')?getParents(b,'ul').forEach(function(a){a.style.display='block'}):null)})}):(k&&(k.setAttribute('data-position',''),k.classList.contains('hide')||k.classList.add('hide')),j&&(j.setAttribute('data-position',''),j.classList.contains('hide')||j.classList.add('hide')))),u=document.getElementById("toggle-toc"),x=document.getElementById('visible-toc'),d=document.querySelector('.toc'),e=document.querySelector('main'),l=document.querySelector('side'),i=document.querySelector('.toc__flexbox'),u?u.addEventListener('change',function(a){a.target.checked?(d&&fadeIn(d,200),i&&i.setAttribute('data-position','fixed'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main-main')),l&&l.classList.remove('main-side')):(d&&fadeOut(d,200),i&&i.setAttribute('data-position','absolute'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main')),l&&l.classList.remove('main-side'))}):null,x?x.addEventListener('change',function(a){a.target.checked?d&&fadeIn(d,200):d&&fadeOut(d,200)}):null),I=120,C=70,K=function(){d&&(d.style.maxHeight=window.innerHeight-I-C+'px')},v=throttle(K,300),v(),window.addEventListener('resize',v),y=new ClipboardJS('.anchor'),r=D.querySelectorAll("h1, h2, h3, h4"),z=JSON.parse('"ltr"'),r?r.forEach(function(c){var d=parseInt(c.tagName.substr(1),10)*2,e=encodeURI(document.location.origin+document.location.pathname),f=e+"#"+c.getAttribute('id'),b=document.createElement('span'),a;b.classList.add('anchor'),b.classList.add('hide'),b.setAttribute('data-clipboard-text',decodeURI(f)),b.style.position='relative',a=document.createElement('span'),a.style.position='absolute',a.style.top='50%',a.style.left='0.75rem',a.style.transform='translateY(-50%)',a.innerHTML=`
<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${32-d}px" height="${32-d}px"><path d="M 5.5625 0 C 4.136719 0 2.707031 0.542969 1.625 1.625 C -0.539063 3.789063 -0.539063 7.335938 1.625 9.5 L 5.28125 13.15625 C 5.667969 13.554688 6.304688 13.558594 6.703125 13.171875 C 7.101563 12.785156 7.105469 12.148438 6.71875 11.75 L 3.03125 8.0625 C 1.632813 6.664063 1.632813 4.429688 3.03125 3.03125 C 4.429688 1.632813 6.664063 1.632813 8.0625 3.03125 L 12.96875 7.9375 C 14.367188 9.335938 14.367188 11.570313 12.96875 12.96875 C 12.804688 13.132813 12.621094 13.25 12.4375 13.375 C 11.980469 13.6875 11.859375 14.308594 12.171875 14.765625 C 12.484375 15.222656 13.105469 15.34375 13.5625 15.03125 C 13.847656 14.835938 14.125 14.625 14.375 14.375 C 16.539063 12.210938 16.539063 8.664063 14.375 6.5 L 9.5 1.625 C 8.417969 0.542969 6.988281 0 5.5625 0 Z M 10.78125 8.875 C 10.738281 8.882813 10.695313 8.894531 10.65625 8.90625 C 10.507813 8.9375 10.371094 9 10.25 9.09375 C 10.039063 9.253906 9.820313 9.429688 9.625 9.625 C 7.460938 11.789063 7.460938 15.335938 9.625 17.5 L 14.5 22.375 C 16.664063 24.539063 20.210938 24.539063 22.375 22.375 C 24.539063 20.210938 24.539063 16.664063 22.375 14.5 L 18.71875 10.875 C 18.476563 10.578125 18.089844 10.441406 17.714844 10.527344 C 17.34375 10.613281 17.050781 10.90625 16.964844 11.277344 C 16.878906 11.652344 17.015625 12.039063 17.3125 12.28125 L 20.96875 15.9375 C 22.367188 17.335938 22.367188 19.570313 20.96875 20.96875 C 19.570313 22.367188 17.335938 22.367188 15.9375 20.96875 L 11.03125 16.0625 C 9.632813 14.664063 9.632813 12.429688 11.03125 11.03125 C 11.152344 10.90625 11.300781 10.820313 11.4375 10.71875 C 11.839844 10.472656 12.015625 9.976563 11.855469 9.53125 C 11.699219 9.085938 11.25 8.8125 10.78125 8.875 Z"/></svg>`,z==="rtl"?a.style.left='-2rem':a.style.right='-2rem',b.append(a),c.append(b),c.addEventListener('mouseenter',function(){this.querySelector('.anchor').classList.remove('hide')}),c.addEventListener('mouseleave',function(){this.querySelector('.anchor').classList.add('hide')})}):null,document.querySelectorAll('.anchor').forEach(function(a){a.addEventListener('mouseleave',function(){a.setAttribute('aria-label',null),a.classList.remove('tooltipped'),a.classList.remove('tooltipped-s'),a.classList.remove('tooltipped-w')})}),y.on('success',function(a){a.clearSelection(),a.trigger.setAttribute('aria-label','Link copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-s')}),b=JSON.parse('["mathjax"]'),b&&b.includes('mermaid')&&(w=localStorage.getItem('theme')||JSON.parse('"dark"'),w==="dark"||w==="hacker"?mermaid.initialize({theme:'dark'}):mermaid.initialize({theme:'default'}),t=[],[].push.apply(t,document.getElementsByClassName('language-mermaid')),t.forEach(function(b){var a=b.parentNode,c;a!==document.body&&(a.parentNode.insertBefore(b,a),a.parentNode.removeChild(a)),c=document.createElement('div'),c.classList.add('mermaid'),c.style.padding='34px 4px 6px',c.innerHTML=b.innerHTML,b.replaceWith(c)})),b&&b.includes('katex')&&(M=document.getElementsByClassName('math'),h={delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]},renderMathInElement(document.querySelector('.single__contents'),h)),b&&b.includes('flowchartjs')&&(h=JSON.parse('{"arrow-end":"block","element-color":"black","fill":"white","flowstate":{"approved":{"fill":"#58C4A3","font-size":12,"no-text":"n/a","yes-text":"APPROVED"},"current":{"fill":"yellow","font-color":"red","font-weight":"bold"},"future":{"fill":"#FFFF99"},"invalid":{"fill":"#444444"},"past":{"fill":"#CCCCCC","font-size":12},"rejected":{"fill":"#C45879","font-size":12,"no-text":"REJECTED","yes-text":"n/a"},"request":{"fill":"blue"}},"font-color":"black","font-size":14,"line-color":"black","line-length":50,"line-width":3,"no-text":"no","scale":1,"symbols":{"end":{"class":"end-element"},"start":{"element-color":"green","fill":"yellow","font-color":"red"}},"text-margin":10,"x":0,"y":0,"yes-text":"yes"}'),c=null,G="language-flowchart",a=0,Array.prototype.forEach.call(document.querySelectorAll("[class^="+G+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='flowchart'+a,b.parentNode.insertBefore(d,b),e=flowchart.parse(c),e.drawSVG("flowchart"+a,h),a+=1})),document.querySelectorAll("mjx-container").forEach(function(a){a.parentElement.classList+='has-jax'}),b&&b.includes('msc')&&(h=JSON.parse('{"theme":"hand"}'),c=null,a=0,m="language-msc",Array.prototype.forEach.call(document.querySelectorAll("[class^="+m+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='msc'+a,b.parentNode.insertBefore(d,b),e=Diagram.parse(c),e.drawSVG("msc"+a,h),a+=1})),b&&b.includes('chart')&&(n="#666",o="#ddd",p=2,Chart.defaults.global.elements.rectangle.borderWidth=p,Chart.defaults.global.elements.rectangle.borderColor=n,Chart.defaults.global.elements.rectangle.backgroundColor=o,Chart.defaults.global.elements.line.borderWidth=p,Chart.defaults.global.elements.line.borderColor=n,Chart.defaults.global.elements.line.backgroundColor=o,Chart.defaults.global.elements.point.borderWidth=p,Chart.defaults.global.elements.point.borderColor=n,Chart.defaults.global.elements.point.backgroundColor=o,m="language-chart",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+m+"]"),function(b){var d,e,f,g;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('canvas'),e=null,d.height=200,d.style.height=200,d.id='myChart'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),f=document.getElementById('myChart'+a).getContext('2d'),g=new Chart(f,e),a+=1})),b&&b.includes('wavedrom')&&(B="language-wave",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+B+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),e=null,d.id='WaveDrom_Display_'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),WaveDrom.RenderWaveForm(a,e,"WaveDrom_Display_"),a+=1})),b&&b.includes('viz')&&(q="language-viz-",Array.prototype.forEach.call(document.querySelectorAll("[class^="+q+"]"),function(a){var b,c;a.style.display='none',a.parentNode.style.backgroundColor="transparent",a.getAttribute("class").split(" ").forEach(function(a){a.startsWith(q)&&(b=a.substr(q.length))}),c=new Viz,c.renderSVGElement(a.innerText,{engine:b}).then(function(b){b.style.width="100%",a.parentNode.insertBefore(b,a)})}))}</script><footer class=footer><div id=gtt><div class=gtt><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 14.71 12 10.83l3.88 3.88c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41.0L6.7 13.3c-.39.39-.39 1.02.0 1.41.39.38 1.03.39 1.42.0z"/></svg></div></div><hr><div class="basicflex flexwrap"><a href=https://gohugo.io/ class=footer__link target=_blank rel=noreferrer>Hugo</a>
<a href=https://zzo-docs.vercel.app/zzo/configuration/params.toml/ class=footer__link target=_blank rel=noreferrer>Zzo</a>
<a href=https://github.com/JohntunLiu/myblog/actions class=footer__link target=_blank rel=noreferrer>GitHubActions</a>
<a href=https://github.com/JohntunLiu/JohntunLiu.github.io/tree/gh-pages class=footer__link target=_blank rel=noreferrer>GitHubPages</a>
<a href=https://gitee.com/JohntunLiu/JohntunLiu/tree/gh-pages/ class=footer__link target=_blank rel=noreferrer>GiteePages</a>
<a href=https://vercel.com/johntunliu/blog class=footer__link target=_blank rel=noreferrer>Vercel</a>
<a href=https://app.forestry.io/dashboard/#/ class=footer__link target=_blank rel=noreferrer>Forestry</a></div><div class=footer__poweredby><p class=caption><a href=mailto:liuzongtang@outlook.com>liuzongtang@outlook.com</a>¬©2021ÁâàÊùÉÊâÄÊúâ</p></div></footer></div><div class="wrapper__right hide" data-pad=true dir=ltr><script>document.querySelector('.wrapper__right').classList.remove('hide')</script></div></div></body></html>